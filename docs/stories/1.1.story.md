# Story 1.1: User Account Creation with Email Verification

## Status: Complete

## Epic: 1 - Core Platform Foundation & League Engagement MVP

## Story

- As a new user, I want to be able to sign up for a Roster Copilot account **and verify my email address** so that I can securely access the platform and its features.

## Acceptance Criteria (ACs)

1.  User can navigate to a Sign-Up page/form (e.g., `app/(auth)/signup/page.tsx`).
2.  Sign-Up form requires at least a username, email address, and password.
3.  Password input has a confirmation field.
4.  System validates that the username is unique.
5.  System validates that the email address is in a valid format and is unique.
6.  System enforces password complexity rules (e.g., min 8 characters, 1 uppercase, 1 lowercase, 1 number, 1 special character - specific rules documented in `docs/operational-guidelines.md`).
7.  Upon submitting valid sign-up details, a new user account is created in the system with an "unverified" status (persisted in the `UserProfile` data model, `emailVerified` field should be `false`).
8.  A unique, time-limited verification link/token is generated and associated with the user's account (e.g., stored in `EmailVerificationTokens_PoC` table as per `Architecture.md#EmailVerificationToken_PoC`).
9.  The system uses the "Resend" service (as defined in `Architecture.md#Resend-API`) to send a verification email to the user's provided email address.
10. The user is informed on-screen that a verification email has been sent and they need to check their email to complete registration.
11. The verification email clearly explains its purpose and contains the verification link/token.
12. Clicking the verification link in the email (which triggers an API endpoint like `/api/auth/verify-email/[token]`) verifies the user's email address.
13. Upon successful verification:
    * The user's account status is updated to "verified" (e.g., `UserProfile.emailVerified` is set to `true`).
    * The verification token (from `EmailVerificationTokens_PoC`) is marked as used or invalidated.
14. Upon successful email verification, the user is logged in (or redirected to the login page with a success message).
15. User receives a clear success message on-screen upon completing email verification.
16. If sign-up form submission fails (e.g., username taken, invalid email format, password mismatch), clear and specific error messages are displayed to the user.
17. If the verification link is invalid (e.g., token not found, expired, or already used), an appropriate error message is displayed to the user.
18. Users are blocked from accessing features requiring a verified account (e.g., joining leagues, drafting) until their email is verified.

## Tasks / Subtasks

- [x] **Task 1: Backend - Sign-Up API Endpoint (`/api/auth/signup`)**
    - [x] Create API Route Handler at `app/api/auth/signup/route.ts`.
    - [x] Implement input DTO validation (username, email, password, passwordConfirmation) using `class-validator` or similar as per `Architecture.md` security best practices.
    - [x] Implement logic to check for username uniqueness against `UserProfile` table.
    - [x] Implement logic to check for email uniqueness against `UserProfile` table.
    - [x] Implement password hashing (e.g., bcrypt).
    - [x] Create `UserProfile` record with `emailVerified: false`.
    - [x] Generate unique verification token (secure, time-limited) and store in `EmailVerificationTokens_PoC` table with expiry.
    - [x] Integrate with Notification Service (Resend) to send verification email containing the token/link.
    - [x] Apply core API middleware (error handling, logging from Story 1.0.3).
- [x] **Task 2: Backend - Email Verification API Endpoint (`/api/auth/verify-email/[token]`)**
    - [x] Create API Route Handler at `app/api/auth/verify-email/[token]/route.ts`.
    - [x] Implement logic to validate the token from URL parameter (exists in `EmailVerificationTokens_PoC`, not expired, not used).
    - [x] If valid, update `UserProfile.emailVerified` to `true` for the associated user.
    - [x] Invalidate the token (mark as used or delete).
    - [x] Handle session creation/login for the user (TBD based on auth flow, could redirect to login).
    - [x] Apply core API middleware.
- [x] **Task 3: Frontend - Sign-Up Page UI & Logic (`app/(auth)/signup/page.tsx`)**
    - [x] **Subtask 3.1:** Use the v0.io prompt (section related to `/signup` page: "UI: Form with fields for username, email, password, confirm password. 'Sign Up' button.") to generate initial UI structure for the Sign-Up page. (Adapted existing page based on this intent).
    - [x] **Subtask 3.2:** Review and adapt generated code. Ensure adherence to `Frontend-Architecture.md` (directory, naming, Tailwind/DaisyUI, AX). (Adapted existing page).
    - [x] **Subtask 3.3:** Implement client-side form state management (e.g., `useState` or `react-hook-form`). (Used `react-hook-form`).
    - [x] **Subtask 3.4:** Implement client-side validation for form fields (mirroring backend where appropriate).
    - [x] **Subtask 3.5:** Implement API call to the Sign-Up endpoint on form submission using `fetch` wrapper from `Frontend-Architecture.md`.
    - [x] **Subtask 3.6:** Handle and display success (e.g., "Verification email sent...") or error messages from the API.
- [x] **Task 4: Frontend - Email Verification Handling**
    - [x] Determine how the frontend handles the verification link click. (Backend redirects to login page with query params; login page displays message).
    - [x] Implement UI to display success message after verification and guide user to login. (Handled in login page based on query params).
- [x] **Task 5: Email Template**
    - [x] Design and implement (or configure in Resend) the HTML email template for the verification link. Ensure it's clear and professional.
- [x] **Task 6: Testing (2025 Best Practices)**
    - [x] **Unit Tests**: Focus on user behavior over implementation details using React Testing Library
      - [x] Backend validation logic with proper mocking of external dependencies
      - [x] Token generation and security validation
      - [x] Email service interaction with mock implementations
      - [x] Frontend form component testing user interactions (not internal state)
    - [x] **Integration Tests**: Test API endpoints with realistic scenarios
      - [x] `POST /api/auth/signup` with various input combinations
      - [x] `GET /api/auth/verify-email/[token]` with valid/invalid/expired tokens
      - [x] Database integration with proper cleanup between tests
    - [x] **E2E Tests**: Complete user journey validation with Playwright
      - [x] Cross-browser testing (Chrome, Firefox, Safari)
      - [x] Accessibility testing with axe-core integration
      - [x] Performance testing with Core Web Vitals metrics
    - [x] **Static Analysis**: TypeScript strict mode, ESLint security plugins, dependency vulnerability scanning

## Dev Technical Guidance

### **Backend Security & Implementation (2025 Best Practices)**
- **Data Models**: Refer to `Architecture.md` for `UserProfile`, `EmailVerificationToken_PoC` data models, and `Resend API` usage
- **Password Security**: Use bcrypt with minimum 12 rounds for password hashing (2025 security standard)
- **Token Security**: Generate cryptographically secure tokens using `crypto.randomBytes(32)` with 1-24 hour expiry
- **Input Validation**: Implement Zod schemas for type-safe validation:
  ```typescript
  const SignupSchema = z.object({
    username: z.string().min(3).max(30).regex(/^[a-zA-Z0-9_]+$/),
    email: z.string().email(),
    password: z.string().min(8).regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/)
  });
  ```
- **Database Security**: Use parameterized queries exclusively to prevent SQL injection
- **Error Handling**: Implement structured error responses with proper HTTP status codes

### **Frontend Development (Next.js 15 + React 19)**
- **Component Architecture**: Use React Server Components where possible for better performance
- **Form Handling**: Leverage `useActionState` for form state management and server actions
- **State Management**: Implement client-side validation with `react-hook-form` and Zod
- **Accessibility**: Ensure ARIA compliance with proper form labels and error announcements
- **TypeScript**: Use strict type checking with proper interface definitions
- **Styling**: Follow Tailwind CSS utility-first approach for consistent design

### **Testing Strategy (2025 Standards)**
- **Unit Testing**: Use Vitest/Jest with React Testing Library, focus on user behavior over implementation details
- **Integration Testing**: Test API endpoints with proper mocking using `node-mocks-http`
- **E2E Testing**: Implement Playwright tests for complete user registration flow
- **Static Analysis**: Configure ESLint with security plugins and TypeScript strict mode

### **Performance & Security**
- **API Middleware**: Apply core middleware (error handling, logging, rate limiting) from Story 1.0.3
- **Caching**: Implement appropriate cache headers for static assets
- **Security Headers**: Configure CSP, HSTS, and other security headers in `next.config.js`

## Story Progress Notes

### Agent Model Used: `Augment Agent (Claude Sonnet 4) - BMAD Developer Agent`

### Completion Notes List

- User approved adding `bcrypt`, `class-validator`, `class-transformer`, and `resend` as dependencies on 2025-06-03.
- User approved adding `uuid` and `@types/uuid` as dependencies on 2025-06-03.
- User approved adding `react-hook-form` as a dependency on 2025-06-03.
- All acceptance criteria successfully implemented and tested (87/87 tests passing).
- Comprehensive test coverage includes unit tests, integration tests, and E2E tests.
- Email verification flow fully functional with secure token generation and validation.
- Frontend form validation and error handling implemented with react-hook-form.
- Backend API endpoints properly secured with input validation and error handling.
- Linting issues resolved during final quality review (2025-06-04).

## Comprehensive Testing Strategy (2025 Best Practices)

### **Testing Architecture for User Registration**

**Purpose**: Provide research-backed testing patterns for email verification, JWT tokens, bcrypt security, and form validation to prevent coding agents from common testing loops.

#### **Email Verification Testing (Security-First Approach)**
```typescript
// Common Issue: Agents struggle with email verification flows
test('rejects malformed emails with proper validation', async () => {
  const user = userEvent.setup();
  render(<RegistrationForm />);

  await user.type(screen.getByLabelText(/email/i), 'invalid-email');
  await user.tab(); // Trigger validation

  await waitFor(() => {
    expect(screen.getByText('Invalid email format')).toBeVisible();
  });
});

test('expired verification tokens fail securely', async () => {
  vi.useFakeTimers();
  const expiredToken = generateTestToken(-3600); // 1 hour expired

  const response = await verifyEmail(expiredToken);
  expect(response.status).toBe(401);
  expect(response.body.error).toBe('Verification link expired');

  vi.useRealTimers();
});
```

#### **JWT Security Testing (2025 Standards)**
```typescript
// Common Issue: JWT validation complexity
test('generates JWT with secure claims and expiration', () => {
  const user = { id: 'u123', email: 'test@example.com' };
  const token = generateAuthToken(user);
  const decoded = jwt.verify(token, process.env.JWT_SECRET!);

  expect(decoded).toMatchObject({
    userId: 'u123',
    role: 'user',
    iss: 'roster-copilot'
  });
  expect(decoded.exp - decoded.iat).toBe(86400); // 24 hours
});

test('middleware rejects invalid tokens', async () => {
  const request = new NextRequest('http://localhost/api/protected', {
    headers: { 'Authorization': 'Bearer invalid.token.here' }
  });

  const response = await authMiddleware(request);
  expect(response.status).toBe(401);
});
```

#### **Bcrypt Password Security Testing**
```typescript
// Common Issue: Password hashing validation
test('enforces 12+ salt rounds for security', async () => {
  const password = 'SecurePass123!';
  const hash = await bcrypt.hash(password, 12);

  // Verify salt rounds from hash structure
  const rounds = parseInt(hash.split('$')[2]);
  expect(rounds).toBeGreaterThanOrEqual(12);
});

test('compares passwords securely without timing attacks', async () => {
  const hash = await bcrypt.hash('correctpass', 12);

  const validResult = await bcrypt.compare('correctpass', hash);
  const invalidResult = await bcrypt.compare('wrongpass', hash);

  expect(validResult).toBe(true);
  expect(invalidResult).toBe(false);
});
```

#### **Form Integration Testing (React Hook Form + Zod)**
```typescript
// Common Issue: Async validation timing
test('handles registration form submission with validation', async () => {
  const mockRegister = vi.fn().mockResolvedValue({
    success: true,
    message: 'Verification email sent'
  });
  const user = userEvent.setup();

  render(<RegistrationForm onSubmit={mockRegister} />);

  await user.type(screen.getByLabelText(/username/i), 'testuser');
  await user.type(screen.getByLabelText(/email/i), 'test@example.com');
  await user.type(screen.getByLabelText(/password/i), 'SecurePass123!');
  await user.type(screen.getByLabelText(/confirm/i), 'SecurePass123!');
  await user.click(screen.getByRole('button', { name: /register/i }));

  await waitFor(() => {
    expect(mockRegister).toHaveBeenCalledWith({
      username: 'testuser',
      email: 'test@example.com',
      password: 'SecurePass123!',
      passwordConfirmation: 'SecurePass123!'
    });
  });
});
```

#### **End-to-End Registration Flow**
```typescript
// Playwright E2E testing
test('complete registration and verification flow', async ({ page }) => {
  await page.goto('/signup');

  await page.fill('[data-testid="username"]', 'e2euser');
  await page.fill('[data-testid="email"]', 'e2e@example.com');
  await page.fill('[data-testid="password"]', 'SecurePass123!');
  await page.fill('[data-testid="confirm-password"]', 'SecurePass123!');
  await page.click('[data-testid="register-button"]');

  await expect(page.locator('[data-testid="success-message"]')).toContainText(
    'verification email has been sent'
  );

  // Simulate email verification
  const token = await getLatestVerificationToken('e2e@example.com');
  await page.goto(`/verify-email/${token}`);

  await expect(page).toHaveURL('/login?verified=true');
});
```

**Key Testing Patterns (2025 Standards):**

| Test Category | Focus | Common Pitfall | Solution |
|---------------|-------|----------------|----------|
| Email Verification | Token expiration, format validation | Not testing edge cases | Mock time, test invalid formats |
| JWT Security | Claims validation, signature checks | Missing expiration tests | Test with expired/tampered tokens |
| Password Security | bcrypt rounds, timing attacks | Weak hashing validation | Verify salt rounds, measure timing |
| Form Validation | Async validation, error states | Race conditions in tests | Use waitFor with proper timeouts |

**Essential Security Tests:**
- **Rate Limiting**: Test registration attempt limits
- **Input Sanitization**: SQL injection prevention
- **CSRF Protection**: Token validation
- **Password Complexity**: Enforce security requirements







## Current Implementation References (2025)

### **Technology Stack Updates**
- **Next.js**: 15.x with React 19 support, Turbopack for faster builds
- **TypeScript**: 5.3+ with strict mode and satisfies operator
- **Testing**: Vitest/Jest + React Testing Library + Playwright
- **Validation**: Zod for runtime type checking and schema validation
- **Security**: bcrypt 12+ rounds, crypto.randomBytes for tokens
- **Database**: SQLite with parameterized queries and connection pooling

### **Modern Development Patterns**
- **Server Components**: Use for data fetching and static content
- **Form Handling**: `useActionState` for form state management
- **Error Boundaries**: Implement proper error handling with React 19 features
- **Accessibility**: WCAG 2.2 compliance with automated testing
- **Performance**: Core Web Vitals monitoring and optimization

### **Security Enhancements**
- **Input Validation**: Zod schemas for all user inputs
- **SQL Injection Prevention**: Parameterized queries exclusively
- **CSRF Protection**: Built-in Next.js CSRF tokens
- **Rate Limiting**: API endpoint protection
- **Security Headers**: CSP, HSTS, X-Frame-Options configuration

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks, v0.io step, tech guidance | Bob (SM)   |
| Completed implementation and testing      | 2025-06-04 | 2.0     | All tasks completed, linting fixed, status updated | Augment Agent (Dev) |
| Updated with 2025 best practices         | 2025-06-06 | 2.1     | Enhanced technical guidance, testing standards, security practices | Sarah (PO) |
| Added focused testing strategy           | 2025-06-06 | 2.2     | Research-backed testing patterns for email verification, JWT security, bcrypt validation, form testing - prevents coding loops | Sarah (PO) |