# Story 2.7: Enhanced Conversational Questionnaire (Gemini-Powered)

## Status: Approved

## Epic: 2 - AI Copilot Onboarding & Personalization Foundation MVP

## Story

- As a new user who has been identified as an "Eager Learner" through AI-powered archetype discovery, I want to continue with an intelligent, conversational questionnaire that adapts to my responses and builds on our previous conversation, so that my preference gathering feels like a natural extension of our chat rather than a separate form-filling exercise.

## Dependencies

- **Prerequisite:** Story 2.6 (AI-Powered Archetype Discovery) must be completed
- **Replaces:** Current static questionnaire logic from Story 2.2
- **Integrates with:** Story 2.5 (Gemini API Conversational Intelligence Foundation)

## Acceptance Criteria (ACs)

1. **Natural Questionnaire Transition**: The questionnaire begins as a seamless continuation of the archetype discovery conversation:
   - Jake naturally transitions from archetype confirmation to preference gathering
   - References the previous conversation and the user's Eager Learner selection
   - Explains the purpose of questions in context of their learning style
   - Maintains conversational momentum and enthusiasm

2. **Intelligent Question Adaptation**: Questions adapt based on user responses and conversation style:
   - **Explanation Depth**: Asks about learning preferences in context of user's demonstrated communication style
   - **Risk Comfort**: Frames risk questions based on user's previous responses about fantasy approach
   - **Follow-up Intelligence**: Generates relevant follow-up questions based on user answers
   - **Conversation Building**: References and builds on previous user statements

3. **Dynamic Question Generation**: Questions feel conversational rather than form-like:
   - Natural language questions that fit the conversation flow
   - Multiple ways to ask the same underlying preference question
   - Adaptive question complexity based on user's apparent expertise level
   - Conversational context that makes questions feel relevant

4. **Flexible Response Handling**: Accepts and understands various response formats:
   - Natural language responses ("I like detailed explanations")
   - Casual responses ("Yeah, give me all the details!")
   - Comparative responses ("More detailed than basic, but not overwhelming")
   - Story-based responses ("Last year I got confused when...")

5. **Conversational Confirmation**: Preference confirmation feels natural and builds excitement:
   - Jake summarizes preferences in conversational language
   - Connects preferences to how he'll provide advice
   - Builds anticipation for the personalized experience
   - Celebrates the completion of preference gathering

6. **Intelligent Conversation Flow**: The questionnaire adapts its flow based on user engagement:
   - Can handle tangents and related questions
   - Allows users to elaborate or ask for clarification
   - Gracefully returns to preference gathering after tangents
   - Adjusts question order based on conversation natural flow

7. **Preference Persistence**: User preferences are saved with proper context:
   - API call to `PUT /api/users/me` with questionnaire responses
   - Preferences saved in structured format for future AI advice personalization
   - Proper error handling maintaining conversational flow
   - Confirmation of successful preference saving

8. **Onboarding Completion**: Natural and enthusiastic completion of the onboarding process:
   - Jake celebrates the completed preference profile
   - Explains how the preferences will improve the user's experience
   - Builds excitement about using the personalized AI advice
   - Smooth transition to the main application dashboard

## Tasks / Subtasks

- [ ] **Task 1: Conversational Questionnaire Engine**
  - [ ] Implement natural questionnaire transition from archetype discovery
  - [ ] Create dynamic question generation based on conversation context
  - [ ] Add conversational question framing and natural language patterns
  - [ ] Implement question flow intelligence and adaptation

- [ ] **Task 2: Intelligent Response Processing**
  - [ ] Create natural language understanding for preference responses
  - [ ] Implement flexible response format handling (casual, detailed, comparative)
  - [ ] Add response validation and clarification request generation
  - [ ] Create preference extraction from conversational responses

- [ ] **Task 3: Adaptive Question System**
  - [ ] Implement question complexity adaptation based on user expertise
  - [ ] Create conversation-aware question selection and ordering
  - [ ] Add follow-up question generation based on user responses
  - [ ] Implement question personalization using conversation history

- [ ] **Task 4: Conversation Building & Memory**
  - [ ] Create natural references to previous conversation parts
  - [ ] Implement conversation continuity across questionnaire flow
  - [ ] Add user statement callback and building functionality
  - [ ] Create conversational context maintenance throughout questionnaire

- [ ] **Task 5: Flexible Flow Management**
  - [ ] Implement conversation tangent handling and graceful returns
  - [ ] Create natural conversation repair for unclear responses
  - [ ] Add conversation branch management for different user approaches
  - [ ] Implement adaptive flow based on user engagement level

- [ ] **Task 6: Preference Intelligence**
  - [ ] Create intelligent preference summarization and confirmation
  - [ ] Implement preference explanation in context of user's learning style
  - [ ] Add preference validation and consistency checking
  - [ ] Create personalized advice preview based on gathered preferences

- [ ] **Task 7: Enhanced API Integration**
  - [ ] Update preference persistence with conversational context
  - [ ] Implement structured preference storage for AI advice personalization
  - [ ] Add conversation-aware error handling and retry logic
  - [ ] Create seamless integration with existing user profile system

- [ ] **Task 8: Completion & Transition Flow**
  - [ ] Implement enthusiastic onboarding completion celebration
  - [ ] Create personalized experience preview and excitement building
  - [ ] Add smooth transition to main application dashboard
  - [ ] Implement completion confirmation and next steps communication

- [ ] **Task 9: Testing & Validation**
  - [ ] Test questionnaire flow across different conversation styles
  - [ ] Validate preference extraction accuracy from natural language responses
  - [ ] Test conversation building and memory functionality
  - [ ] Verify API integration and preference persistence

- [ ] **Task 10: Story Completion**
  - [ ] All acceptance criteria met and validated
  - [ ] Enhanced conversational questionnaire fully functional
  - [ ] Complete AI-powered onboarding flow operational
  - [ ] Story marked as Complete following BMAD methodology

## Dev Technical Guidance

- **Conversational Questionnaire (Advanced NLP Techniques 2025):**
  - Leverage Gemini 2.5 Pro's multi-tool capabilities for dynamic question generation
  - Implement continuous learning systems with real-time knowledge base updates
  - Use bias monitoring and adversarial testing for demographic response patterns
  - Deploy transparency cues and fallback protocols for ethical AI interactions
  - Reference: [AI Conversation Best Practices](https://respond.io/blog/conversational-ai-best-practices/)

- **Response Processing:**
  - Implement robust natural language understanding for preference extraction
  - Create response validation that maintains conversational flow
  - Use conversation context for response interpretation and clarification
  - Implement preference confidence scoring and validation

- **Flow Intelligence:**
  - Create adaptive questionnaire flow based on user engagement and responses
  - Implement conversation tangent handling with graceful returns to preferences
  - Use conversation momentum and energy level for flow adaptation
  - Create natural conversation repair and clarification strategies

- **Preference Management:**
  - Implement structured preference storage compatible with future AI advice personalization
  - Create preference summarization and confirmation in conversational language
  - Use conversation context for preference explanation and relevance
  - Implement preference consistency checking and validation

- **API Integration (Enterprise-Grade Implementation):**
  - Extend existing user profile system with structured preference storage schema
  - Implement Redis-based tracking for distributed conversation context management
  - Use token bucket algorithm for burst protection during questionnaire interactions
  - Add comprehensive monitoring with rate limit headers and observability logging
  - Reference: [Next.js Enterprise API Patterns](https://nextjs.org/docs/api-routes/introduction)

- **Architecture References:**
  - Preference Storage Schema: `docs/data-models.md#user-preference-schema`
  - User Profile System: `docs/api-reference.md#user-profile-endpoints`
  - Conversation Context: `docs/front-end-state-management.md#conversation-context-management`
  - Integration Points: `docs/Architecture.md#conversation-intelligence-engine`

## Story Progress Notes

### Agent Model Used: `<Agent Model Name/Version>`

### Completion Notes List

{Implementation notes will be added during development}

### Change Log

| Change                    | Date       | Version | Description                                    | Author        |
| ------------------------- | ---------- | ------- | ---------------------------------------------- | ------------- |
| Initial Story Creation    | 2025-06-06 | 1.0     | Created enhanced conversational questionnaire story | Jack (PM) |
| References Updated        | 2025-06-06 | 1.1     | Enhanced with latest 2025 best practices      | Bob (SM)      |
| Status Approved           | 2025-06-06 | 1.2     | Story validated and approved for development   | Bob (SM)      |
