# Story 1.8: Core Live Online Snake Draft Room Interface

## Status: Approved

## Epic: 1 - Core Platform Foundation & League Engagement MVP

## Story

- As a logged-in user in an active league, I want to access a live online draft room that supports a snake draft format so that I can select players for my team in real-time with other league members.

## Acceptance Criteria (ACs)

1.  When a `League_PoC.draftStatus` is "Scheduled" or "InProgress", users participating in that league can navigate to and enter the "Live Draft Room" page (e.g., `app/(main)/draft/[leagueId]/page.tsx`).
2.  The Draft Room displays a visual draft board showing all draft picks by team and round.
3.  The Draft Room clearly indicates the current team on the clock and the time remaining for their pick (PoC: pick timer 60-90 seconds, strict auto-pick enforcement out of scope for MVP).
4.  The Draft Room displays a list of available `NFLPlayer` records (from static data).
5.  The available player list is filterable by position (QB, RB, WR, TE, K, DEF).
6.  Available player information in the list includes at least `fullName`, `position`, `nflTeamAbbreviation`, and `projectedPoints` (using the `DraftPlayerCard.tsx` component from Story 5 of v0.io prompt, or similar).
7.  A user whose turn it is to pick can select an available player from the list and confirm their pick.
8.  Once a player is picked:
    * The player is removed from the available player list for the league.
    * The player is added to the drafting user's `FantasyTeam_PoC.playerIds_onRoster`.
    * The draft board is updated to reflect the pick.
9.  The draft proceeds in a snake order (e.g., Teams 1-N, N-1, 1-N).
10. Users can view their current team roster as it's being built within the Draft Room UI.
11. The system updates the draft board, current pick, available players, and team rosters in near real-time for all users in the Draft Room (PoC: Polling API for draft state updates is acceptable; WebSockets are a stretch goal).
12. When the draft is completed (all teams fill rosters per `League_PoC.rosterSettings`), the system indicates draft end.
13. The `League_PoC.draftStatus` is updated to "InProgress" when the draft starts (e.g., first pick or manual commissioner start – manual start is fine for PoC) and "Completed" when it ends.
14. PoC: Assumes all users are online; no auto-pick for absent users.
15. A designated area for the AI Copilot Co-Pilot panel (from Story 3.1 onwards) is present in the layout, but its functionality is not part of *this* story's ACs.

## Tasks / Subtasks

- [ ] **Task 1: Backend - Draft State Management & API Endpoints**
    - [ ] **Subtask 1.1:** Design/refine backend logic to manage the full draft state: draft order (snake), current pick, timer (if tracked server-side), players picked by each team, remaining available players for the league.
    - [ ] **Subtask 1.2:** Create/Update API endpoint to get current draft status and details (`GET /api/leagues/[leagueId]/draft`).
        - [ ] Response should include: current picker, time remaining (if any), full draft board (picks made), user's current roster, and a list of currently available `NFLPlayer` IDs (frontend can then fetch details or these can be included).
    - [ ] **Subtask 1.3:** Create API endpoint to make a draft pick (`POST /api/leagues/[leagueId]/draft/pick`).
        - [ ] Input: `playerId`.
        - [ ] Validate: User's turn, player availability, valid player ID.
        - [ ] Update `FantasyTeam_PoC.playerIds_onRoster`.
        - [ ] Update overall draft state (mark player as picked, advance to next picker).
    - [ ] **Subtask 1.4:** Implement logic to initialize the draft (set order, available players from league's universe of players – for PoC this is all `NFLPlayer` static data).
    - [ ] **Subtask 1.5:** Implement logic to update `League_PoC.draftStatus`.
    - [ ] Apply core API middleware.
- [ ] **Task 2: Frontend - Draft Room UI & Logic (`app/(main)/draft/[leagueId]/page.tsx`)**
    - [ ] **Subtask 2.1:** Use the v0.io prompt (section related to `/draft/:leagueId` page: "Key Elements: Draft board... available player list... AI Co-Pilot panel area.") to generate the initial UI structure for the Draft Room page.
    - [ ] **Subtask 2.2:** Review and adapt generated code. Ensure adherence to `Frontend-Architecture.md`.
    - [ ] **Subtask 2.3:** Implement Draft Board UI: Grid display of picks, showing player name/team/position once picked.
    - [ ] **Subtask 2.4:** Implement Available Player List UI:
        - [ ] Use/adapt the `DraftPlayerCard.tsx` component (specified in v0.io prompt, Story 5) for displaying each player.
        - [ ] Implement filters for player position.
        - [ ] Implement action to select a player for drafting when it's the user's turn.
    - [ ] **Subtask 2.5:** Implement "My Current Roster" display area.
    - [ ] **Subtask 2.6:** Display current picker, round/pick number, and a simple timer (client-side timer acceptable for PoC visual).
    - [ ] **Subtask 2.7:** Implement logic to fetch draft state periodically (polling `GET /api/leagues/[leagueId]/draft`) and update all relevant UI sections.
    - [ ] **Subtask 2.8:** When it's the user's turn, enable pick confirmation button. On click, call `POST /api/leagues/[leagueId]/draft/pick`.
    - [ ] **Subtask 2.9:** Handle UI updates based on API responses (e.g., successful pick, error messages).
    - [ ] **Subtask 2.10:** Ensure placeholder area for AI Co-Pilot Panel is integrated into the layout.
- [ ] **Task 3: Testing**
    - [ ] Unit tests for backend draft logic (snake order, pick validation, state updates).
    - [ ] Unit tests for key frontend components (Player List, Draft Board display logic).
    - [ ] Integration tests for `GET /api/leagues/[leagueId]/draft` and `POST /api/leagues/[leagueId]/draft/pick` API endpoints.
    - [ ] E2E test for a user participating in a simplified draft: viewing draft board, filtering players, making a pick, seeing board/roster update.

## Dev Technical Guidance

- **Backend:**
    - Robust state management for the draft is crucial on the backend. Consider how draft order, picks, and available players are tracked and updated atomically.
    - The `GET /api/leagues/[leagueId]/draft` endpoint will be polled by clients, so it should be efficient.
- **Frontend:**
    - Leverage the v0.io prompt for the initial UI of the Draft Room, including the `DraftPlayerCard.tsx`. Developer Agent will need to refine and integrate this heavily.
    - Efficiently re-rendering the UI based on polled draft state updates is important. Minimize unnecessary re-renders.
    - The UI should clearly distinguish whose turn it is and provide clear actionability when it's the current user's turn.
- **Real-time (PoC):** Polling for draft state every 5-10 seconds is an acceptable PoC approach. If WebSockets are attempted as a stretch, they would replace this polling for clients that support them.
- **Data:** Ensure the static `NFLPlayer` list is sufficient for multiple teams to complete a draft according to `League_PoC.rosterSettings`.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks, v0.io step, tech guidance | Bob (SM)   |