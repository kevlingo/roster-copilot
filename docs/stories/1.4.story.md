# Story 1.4: View/Edit Basic Profile Information

## Status: Approved

## Epic: 1 - Core Platform Foundation & League Engagement MVP

## Story

- As a registered user, I want to be able to view and edit my basic profile information so that I can keep my account details up to date.

## Acceptance Criteria (ACs)

1.  A logged-in user can navigate to a "Profile" or "Account Settings" page (e.g., `app/(main)/copilot/profile/page.tsx`).
2.  The Profile page displays the user's current basic information (e.g., username, email from their `UserProfile` data model).
3.  The user has an option to edit their profile information (e.g., an "Edit Profile" button or inline editing capabilities for sections like username, email, password).
4.  When editing, the user can update their username, subject to uniqueness validation by the backend.
5.  When editing, the user can update their email address.
    * If the email address is changed, the system MUST trigger a re-verification process for the new email address (similar to Story 1.1). The `UserProfile.emailVerified` status for the new email should initially be `false`, and the old email effectively becomes unverified for login purposes if the change is committed before new email verification. (Consider UX implications: perhaps new email is pending until verified).
6.  When editing, the user can change their password.
    * Changing password requires them to enter their current password for verification.
    * New password input requires a confirmation field.
    * New password must adhere to defined complexity rules (as per `docs/operational-guidelines.md`).
7.  The system validates all changes (e.g., new username uniqueness, new email format and uniqueness, password complexity, current password correctness) on the backend. Client-side validation should provide initial feedback.
8.  Upon successful update of any profile information, changes are persisted to the user's `UserProfile` in the database.
9.  User receives a clear success message upon updating their profile (e.g., "Profile updated successfully," "Password changed successfully," "Verification email sent to your new address").
10. If an update fails (e.g., username/email already taken, incorrect current password, new passwords don't match), clear and specific error messages are displayed to the user.
11. The AI Copilot related preferences (like selected archetype from Story 2.1 or onboarding answers from Story 2.2), which may also be displayed on this page, are presented as read-only as per their respective story scopes (viewing covered in Story 2.4).

## Tasks / Subtasks

- [ ] **Task 1: Backend - Update User Profile API Endpoint(s)**
    - [ ] Design and implement API endpoint(s) to handle updates for username, email, and password. This could be a single `PUT /api/users/me` endpoint that intelligently handles partial updates, or separate more granular endpoints (e.g., `/api/users/me/username`, `/api/users/me/email`, `/api/users/me/password`).
    - [ ] For username update: Implement input validation and uniqueness check.
    - [ ] For email update: Implement input validation, uniqueness check, and logic to trigger the email re-verification process (generate new token, send email via Resend, set `emailVerified` to `false` for the new email or manage a pending email state).
    - [ ] For password update: Implement current password verification, new password complexity validation, and secure hashing of the new password.
    - [ ] Ensure all updates modify the correct `UserProfile` record in the database.
    - [ ] Apply core API middleware (error handling, logging from Story 1.0.3).
- [ ] **Task 2: Frontend - Profile Page UI & Logic (`app/(main)/copilot/profile/page.tsx`)**
    - [ ] **Subtask 2.1:** Use the v0.io prompt (section related to `/copilot/profile` page: "Key Elements: Display of username, email. Forms/inputs for editing profile information... Read-only display of AI Copilot preferences.") to generate the initial UI structure for the Profile page.
    - [ ] **Subtask 2.2:** Review and adapt generated code. Ensure adherence to `Frontend-Architecture.md`.
    - [ ] **Subtask 2.3:** Display current user information (username, email) fetched from an appropriate user state or API.
    - [ ] **Subtask 2.4:** Implement forms/input sections for editing username, email, and changing password (current password, new password, confirm new password).
    - [ ] **Subtask 2.5:** Implement client-side validation for all editable fields.
    - [ ] **Subtask 2.6:** Handle API calls to the backend endpoint(s) for updating profile information.
    - [ ] **Subtask 2.7:** Display success messages (e.g., "Username updated," "Password changed," "Please check your new email address to verify it.") or specific error messages from the API.
    - [ ] **Subtask 2.8:** Handle UI flow for email re-verification if email is changed (e.g., inform user, update displayed email to show it's pending verification).
    - [ ] **Subtask 2.9:** Ensure AI Copilot preferences (from Story 2.4) are displayed as read-only.
- [ ] **Task 3: Email Template (for new email verification)**
    - [ ] Design and implement (or configure in Resend) the HTML email template for verifying a changed email address.
- [ ] **Task 4: Testing**
    - [ ] Write unit tests for backend profile update logic, validations, password hashing, email re-verification trigger.
    - [ ] Write unit tests for frontend profile page components and forms (validation, state handling, API call mocking).
    - [ ] Write integration tests for the profile update API endpoint(s), covering successful updates and error conditions for each field.
    - [ ] Write E2E tests for: viewing profile, successfully editing username, successfully changing password, successfully changing email and triggering re-verification, and attempting invalid updates.

## Dev Technical Guidance

- **Backend:**
    - Refer to `Architecture.md` for the `UserProfile` data model and `Resend API` usage.
    - Consider the security implications and UX of email changes: should the old email remain active until the new one is verified? How is login affected during this period? For PoC, a simple approach is to update the email and mark it unverified, requiring re-verification for full functionality or login with the new email.
    - All update operations should be atomic where possible.
- **Frontend:**
    - Leverage the v0.io prompt for the initial UI of the `/copilot/profile` page.
    - Clearly separate display of information from editing states/forms.
    - User feedback (success/error messages, loading states) is crucial.
- **General:**
    - API endpoint(s) must be protected and use the core API middleware.
    - Password complexity rules from `docs/operational-guidelines.md` must be enforced on both client and server.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks, v0.io step, tech guidance | Bob (SM)   |