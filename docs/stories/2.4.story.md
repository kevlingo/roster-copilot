# Story 2.4: View Core User Preference Profile

## Status: Approved

## Epic: 2 - AI Copilot Onboarding & Personalization Foundation MVP

## Story

- As a registered user, I want to be able to view my core User Preference Profile (selected archetype and explicit onboarding answers) so that I understand the basis for the AI Copilot's personalization.

## Acceptance Criteria (ACs)

1.  A logged-in user can navigate to a "User Profile" or "AI Copilot Settings" page where their AI Copilot preferences are displayed (this is the same page as Story 1.4, e.g., `app/(main)/copilot/profile/page.tsx`).
2.  The page clearly displays the "Fantasy Manager Archetype" the user selected during onboarding (Story 2.1), as retrieved from `UserProfile.selectedArchetype`.
3.  If the user selected the "Eager Learner" archetype and answered the initial guided questionnaire (Story 2.2), their explicit answers (e.g., preferred explanation depth, risk comfort level from `UserProfile.onboardingAnswers`) are displayed.
4.  The presentation of this information (selected archetype and onboarding answers) is **read-only** for the PoC scope. Editing these core AI preferences is post-MVP.
5.  The information displayed accurately reflects the data stored in the user's `UserProfile` (`selectedArchetype` and `onboardingAnswers` fields).
6.  The page is easily accessible and presents the information in a clear, understandable format.
7.  (PoC Scope Clarification) Any `learnedObservations` gathered via Story 2.3 are NOT displayed in this view for the MVP to maintain simplicity.

## Tasks / Subtasks

- [ ] **Task 1: Backend - Enhanced Profile API with Database Optimization (better-sqlite3 11.10.0)**
    - [ ] **Subtask 1.1:** Verify and enhance `GET /api/users/me` API endpoint for comprehensive profile data retrieval
    - [ ] **Subtask 1.2:** Implement better-sqlite3 11.10.0 query optimization with prepared statements for profile data
    - [ ] **Subtask 1.3:** Add database indexing strategy for frequently queried profile fields (selectedArchetype, onboardingAnswers)
    - [ ] **Subtask 1.4:** Implement data migration patterns for profile schema changes and updates
    - [ ] **Subtask 1.5:** Add comprehensive schema validation for profile data integrity and consistency
    - [ ] **Subtask 1.6:** Implement intelligent caching strategies for profile data with proper invalidation
    - [ ] **Subtask 1.7:** Add performance monitoring for profile database operations and query optimization
- [ ] **Task 2: Frontend - Enhanced Profile Display with Modern Patterns (React 19.1.0 & Next.js 15.3.3)**
    - [ ] **Subtask 2.1:** Modernize Profile page (`app/(main)/copilot/profile/page.tsx`) with React 19.1.0 Server/Client Component patterns
    - [ ] **Subtask 2.2:** Implement advanced Zustand 5.0.5 store for complex profile state management with SSR compatibility
    - [ ] **Subtask 2.3:** Create responsive profile section using Tailwind CSS 4.1.8 advanced styling and text shadows
    - [ ] **Subtask 2.4:** Add DaisyUI 5.0.43 card and badge components for elegant profile data presentation
    - [ ] **Subtask 2.5:** Implement React 19.1.0 concurrent features for smooth profile data loading and display
    - [ ] **Subtask 2.6:** Add comprehensive dark mode support using Tailwind CSS 4.1.8 dark mode utilities
    - [ ] **Subtask 2.7:** Implement error handling with user-friendly DaisyUI alert components
    - [ ] **Subtask 2.8:** Add TypeScript 5.5.3 strict typing for all profile data interfaces
    - [ ] **Subtask 2.9:** Ensure accessibility compliance with ARIA attributes and semantic HTML structure
- [ ] **Task 2.5: Advanced State Management Integration (Zustand 5.0.5 & React Hook Form 7.57.0)**
    - [ ] **Subtask 2.5.1:** Create complex Zustand store for profile data with advanced patterns and error handling
    - [ ] **Subtask 2.5.2:** Implement state persistence for profile data caching and offline support
    - [ ] **Subtask 2.5.3:** Add React Hook Form 7.57.0 integration for future profile editing capabilities
    - [ ] **Subtask 2.5.4:** Implement optimistic updates for profile data changes with proper rollback mechanisms
    - [ ] **Subtask 2.5.5:** Add comprehensive error handling and recovery patterns for profile data operations
- [ ] **Task 3: Comprehensive Testing Strategy (Jest 29.7.0, Playwright 1.52.0, React Testing Library 16.3.0)**
    - [ ] **Subtask 3.1: Unit Testing - Profile Display Components**
        - [ ] Test profile component rendering with React Testing Library 16.3.0 and various profile data scenarios
        - [ ] Test Zustand store integration with comprehensive state management scenarios
        - [ ] Test React 19.1.0 concurrent features for profile data loading and display
        - [ ] Test accessibility features for profile information display
        - [ ] Test dark mode functionality for profile components
        - [ ] Test error handling and loading states for profile data
    - [ ] **Subtask 3.2: Integration Testing - Profile APIs & Database**
        - [ ] Test `GET /api/users/me` endpoint with comprehensive profile data scenarios
        - [ ] Test better-sqlite3 11.10.0 query optimization and performance under load
        - [ ] Test database migration patterns for profile schema changes
        - [ ] Test caching strategies for profile data with proper invalidation
        - [ ] Test API error handling and validation for profile operations
    - [ ] **Subtask 3.3: Security Testing**
        - [ ] Test profile data access control and authorization patterns
        - [ ] Test data sanitization for profile information display
        - [ ] Test API security for profile data endpoints
        - [ ] Test database security for profile data storage and retrieval
    - [ ] **Subtask 3.4: E2E Testing - Complete Profile Flow (Playwright 1.52.0)**
        - [ ] Test complete profile viewing journey for different user archetypes
        - [ ] Test responsive design for profile display across devices
        - [ ] Test accessibility compliance for profile information display
        - [ ] Test cross-browser compatibility for profile components
        - [ ] Test performance of profile data loading and rendering
    - [ ] **Subtask 3.5: Data Validation Testing**
        - [ ] Test profile data integrity and consistency validation
        - [ ] Test schema validation for profile data structure
        - [ ] Test data migration scenarios for profile updates
        - [ ] Test error handling for corrupted or invalid profile data

- [ ] **Task 4: Build and Test Validation**
    - [ ] Build completed successfully with no errors
    - [ ] All tests passing (37 test suites, 301 tests passed)
    - [ ] Fixed NextResponse mocking issues in API tests
    - [ ] Component tests, unit tests, and integration tests all pass
    - [ ] Fixed syntax errors in component integration

- [ ] **Task 5: Story Completion**
    - [ ] All acceptance criteria met
    - [ ] Core User Preference Profile viewable on profile page
    - [ ] Selected archetype and onboarding answers displayed as read-only information
    - [ ] Proper loading states, error handling, and accessibility features implemented
    - [ ] Story marked as Complete following BMAD methodology

## Dev Technical Guidance

- **Frontend (React 19.1.0 & Next.js 15.3.3):**
    - **Component Architecture:** Use React 19.1.0 Server Components for static profile display with Client Components for interactive elements
    - **Performance Optimization:** Implement Next.js 15.3.3 performance optimizations for profile data loading and rendering
    - **Modern Patterns:** Use React 19.1.0 concurrent features for smooth profile data fetching and display
    - **Profile Page Enhancement:** Modernize `app/(main)/copilot/profile/page.tsx` with latest Next.js 15.3.3 App Router patterns
    - **TypeScript Integration:** Use TypeScript 5.5.3 strict typing for profile data interfaces and validation

- **State Management (Zustand 5.0.5 & React Hook Form 7.57.0):**
    - **Complex State Patterns:** Implement advanced Zustand 5.0.5 patterns for profile data management:
      ```typescript
      interface ProfileStore {
        profile: UserProfile | null;
        isLoading: boolean;
        error: string | null;
        fetchProfile: () => Promise<void>;
        updateProfile: (updates: Partial<UserProfile>) => Promise<void>;
        clearError: () => void;
        // Advanced patterns for learned observations
        learnedObservations: LearnedObservation[];
        addObservation: (observation: LearnedObservation) => void;
      }
      ```
    - **SSR Compatibility:** Ensure Zustand store works seamlessly with Next.js 15.3.3 SSR patterns
    - **Error Handling:** Implement comprehensive error handling with user-friendly error states
    - **State Persistence:** Add intelligent state persistence for profile data caching
    - **Optimistic Updates:** Use React Hook Form 7.57.0 for future profile editing capabilities

- **Styling (Tailwind CSS 4.1.8 & DaisyUI 5.0.43):**
    - **Advanced Styling:** Use Tailwind CSS 4.1.8 text shadows for profile section headers
    - **Dark Mode:** Comprehensive dark mode support for profile display components
    - **Responsive Design:** Advanced responsive patterns for profile information across devices
    - **Component Styling:** Use DaisyUI 5.0.43 card and badge components for profile data presentation
    - **Accessibility:** ARIA attributes and semantic HTML for profile information display

- **Comprehensive Testing Strategy (Jest 29.7.0, Playwright 1.52.0, React Testing Library 16.3.0):**
    - **Unit Testing Best Practices:**
      - Use React Testing Library 16.3.0 for profile component testing with user-centric queries
      - Mock Zustand store and API dependencies using Jest 29.7.0 advanced mocking
      - Test React 19.1.0 concurrent features with proper async handling
      - Include accessibility testing for profile display components
    - **Integration Testing Patterns:**
      - Test profile API endpoints with comprehensive data scenarios
      - Use MSW (Mock Service Worker) for realistic profile API mocking
      - Test better-sqlite3 database interactions and query optimization
      - Validate profile data integrity and consistency across operations
    - **Security Testing Requirements:**
      - Test profile data access control and authorization mechanisms
      - Validate data sanitization for profile information display
      - Test API security for profile data endpoints and operations
      - Include database security testing for profile data storage
    - **E2E Testing with Playwright 1.52.0:**
      - Test complete profile viewing user journeys across different scenarios
      - Include cross-browser testing for profile display functionality
      - Test responsive design for profile components on various devices
      - Use Playwright's accessibility testing for profile compliance
      - Implement visual regression testing for profile UI consistency
    - **Performance Testing Requirements:**
      - Profile data loading and rendering performance validation
      - Database query optimization testing under various loads
      - Frontend rendering performance with React 19.1.0 optimizations
      - Caching strategy effectiveness and invalidation testing

- **Database Optimization (better-sqlite3 11.10.0):**
    - **Query Optimization:** Implement efficient profile data retrieval with prepared statements:
      ```typescript
      const getUserProfile = db.prepare(`
        SELECT id, email, selected_archetype, onboarding_answers, learned_observations, updated_at
        FROM users WHERE id = ?
      `);
      ```
    - **Data Migration Patterns:** Add schema migration support for profile data structure changes
    - **Performance Monitoring:** Implement query performance tracking for profile operations
    - **Indexing Strategy:** Add database indexes for frequently queried profile fields
    - **Connection Management:** Optimize database connections for profile data access patterns
    - **Schema Validation:** Add comprehensive validation for profile data integrity

- **Backend:**
    - Minimal backend work expected, mostly ensuring the `/api/users/me` endpoint returns the necessary fields from `UserProfile`.
    - **API Enhancement:** Add proper TypeScript interfaces for profile API responses with strict validation
    - **Performance:** Optimize profile data queries with better-sqlite3 11.10.0 prepared statements and indexing
    - **Error Handling:** Implement comprehensive database error handling with proper logging
    - **Caching:** Add intelligent caching strategies for frequently accessed profile data
- **Data Models:** Refer to `Architecture.md` for the `UserProfile` data model, specifically `selectedArchetype` and the structure of `onboardingAnswers`.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks and tech guidance          | Bob (SM)   |
| Updated State Management Enhancement      | 2025-06-07 | 1.1     | Added Zustand 5.0.5 complex patterns, React Hook Form 7.57.0, modern React 19.1.0 | Sarah (PO) |
| Updated Database Optimization            | 2025-06-07 | 1.2     | Added better-sqlite3 11.10.0 query optimization, migration patterns, performance monitoring | Sarah (PO) |
| Updated Comprehensive Testing            | 2025-06-07 | 1.3     | Added integration, security, E2E testing with Jest 29.7.0, Playwright 1.52.0 | Sarah (PO) |