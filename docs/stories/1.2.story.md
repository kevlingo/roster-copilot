# Story 1.2: User Login

## Status: Approved

## Epic: 1 - Core Platform Foundation & League Engagement MVP

## Story

- As a registered user, I want to be able to log in to my Roster Copilot account using my credentials so that I can access my leagues and personalized features.

## Acceptance Criteria (ACs)

1.  User can navigate to a Login page/form (e.g., `app/(auth)/login/page.tsx`).
2.  Login form requires the user's email address (or username, though email is specified as primary in `UserProfile`) and password.
3.  Upon submitting valid credentials, the system authenticates the user against their stored `UserProfile` (specifically checking the email and hashed password).
4.  The system verifies that the `UserProfile.emailVerified` status is `true` before allowing login.
5.  Upon successful authentication and email verification:
    * A persistent session is created for the logged-in user (e.g., using JWTs stored securely as per `Architecture.md` security best practices).
    * The user is granted access to the authenticated parts of the application.
    * The user is redirected to their main dashboard (e.g., `/dashboard`).
6.  If authentication fails (e.g., incorrect email/password, or `UserProfile.emailVerified` is `false`):
    * A clear and non-specific error message (e.g., "Invalid credentials. Please check your email and password, or ensure your email is verified.") is displayed.
    * The user remains on the Login page.
7.  The system includes protection against brute-force login attempts (e.g., rate limiting on the login API endpoint â€“ as a general security NFR from `Architecture.md`).
8.  The Login page provides a link to "Forgot Password?" functionality (to be implemented in Story 1.5).

## Tasks / Subtasks

- [ ] **Task 1: Backend - Login API Endpoint (`/api/auth/login`)**
    - [ ] Create API Route Handler at `app/api/auth/login/route.ts`.
    - [ ] Implement input DTO validation (email, password).
    - [ ] Retrieve `UserProfile` by email.
    - [ ] If user found, verify submitted password against stored hash.
    - [ ] Check if `UserProfile.emailVerified` is `true`.
    - [ ] If authentication and verification are successful, generate session token (e.g., JWT with appropriate claims and expiry).
    - [ ] Implement rate limiting on this endpoint.
    - [ ] Return user information and token in the response.
    - [ ] Apply core API middleware (error handling, logging from Story 1.0.3).
- [ ] **Task 2: Frontend - Login Page UI & Logic (`app/(auth)/login/page.tsx`)**
    - [ ] **Subtask 2.1:** Use the v0.io prompt (section related to `/login` page: "UI: Form with fields for email/username and password. 'Login' button. Link to 'Forgot Password?'") to generate initial UI structure for the Login page.
    - [ ] **Subtask 2.2:** Review and adapt generated code. Ensure adherence to `Frontend-Architecture.md` (directory, naming, Tailwind/DaisyUI, AX).
    - [ ] **Subtask 2.3:** Implement client-side form state management.
    - [ ] **Subtask 2.4:** Implement client-side validation for form fields.
    - [ ] **Subtask 2.5:** Implement API call to the Login endpoint on form submission.
    - [ ] **Subtask 2.6:** Upon successful login, securely store the session token (e.g., in memory via Zustand store, as per `Frontend-Architecture.md` token handling strategy) and user information.
    - [ ] **Subtask 2.7:** Redirect to the dashboard (`/dashboard`) upon successful login.
    - [ ] **Subtask 2.8:** Handle and display API error messages (e.g., "Invalid credentials," "Email not verified").
    - [ ] **Subtask 2.9:** Implement the "Forgot Password?" link (pointing to the route for Story 1.5).
- [ ] **Task 3: Testing**
    - [ ] Write unit tests for backend authentication logic (password verification, email verification check).
    - [ ] Write unit tests for frontend login form component (validation, submission).
    - [ ] Write integration tests for the login API endpoint, including scenarios for success, invalid credentials, and unverified email.
    - [ ] Write E2E test for the user login flow (happy path, incorrect password, unverified email) using Playwright.

## Dev Technical Guidance

- **Backend:**
    - Refer to `Architecture.md` for `UserProfile` data model (including `emailVerified` field) and authentication/session management strategy (e.g., JWTs).
    - Password verification must use the same secure hashing algorithm implemented in Story 1.1.
    - JWTs should contain necessary claims (e.g., `userId`, roles if any) and have a defined expiry.
- **Frontend:**
    - Use the v0.io prompt as a starting point for the `/login` page UI. The Developer Agent will refine and integrate this.
    - Secure handling of the session token on the client-side is critical, as per `Frontend-Architecture.md`. Storing in memory via a state management solution like Zustand (if used for session state) is preferred over `localStorage`.
    - Ensure redirects and error message displays are user-friendly.
- **General:**
    - All API endpoints must be protected by the core API middleware (error handling, logging) established in Story 1.0.3.
    - The login process is a critical security checkpoint; pay close attention to detail.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks, v0.io step, tech guidance | Bob (SM)   |