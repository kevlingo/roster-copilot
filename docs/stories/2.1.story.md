# Story 2.1: Implement Fantasy Manager Archetype Selection Interface

## Status: Approved

## Epic: 2 - AI Copilot Onboarding & Personalization Foundation MVP

## Story

- As a new user undergoing AI Copilot onboarding, I want to be presented with a selection of predefined "Fantasy Manager Archetypes" so that I can choose one that best reflects my initial approach or experience level with fantasy football.

## Acceptance Criteria (ACs)

1.  During the AI Copilot onboarding flow (e.g., on `app/(main)/onboarding/page.tsx` or within the `AIPanel.tsx`), after initial account creation/login and email verification (Story 1.1), the user is presented with an archetype selection interface.
2.  The interface clearly displays the predefined "Fantasy Manager Archetypes" as specified in `Architecture.md` and `Prd.md`: "Eager Learner," "Calculated Strategist," "Bold Playmaker," "Busy Optimizer."
3.  Each archetype option is presented using an engaging UI element, such as an "Archetype Card" (as conceptualized in `UIUX_Spec.md` and detailed for v0.io prompt Story 5).
4.  Each Archetype Card includes a brief, engaging description of its characteristics. The description for "Eager Learner" specifically caters to users new to or still learning fantasy football.
5.  The user can select only one archetype at a time. Selecting one archetype visually indicates its selection and deselects any other.
6.  The user's selection of an archetype is captured by the frontend.
7.  Upon confirming their selection (e.g., via a "Continue" button or by the selection itself being the trigger), the chosen `selectedArchetype` is persisted to the user's `UserProfile` via an API call.
8.  Upon successful persistence of the selection, the system proceeds to the next step in the onboarding flow:
    * If "Eager Learner" is selected, the user is presented with the brief guided questionnaire (as per Story 2.2).
    * If another archetype is selected, the PoC onboarding for archetype/initial questions might conclude here, proceeding to profile confirmation or main app (as per Story 2.3 planning).
9.  The interface for archetype selection is visually appealing, responsive, and easy to use, adhering to the "modern, clean, engaging pop" aesthetic.

## Tasks / Subtasks

- [ ] **Task 1: Backend - Ensure Profile Update Capability for Archetype**
    - [ ] Verify the existing `PUT /api/users/me` API endpoint (from Story 1.4) can accept and update the `UserProfile.selectedArchetype` field.
    - [ ] Ensure backend validation allows for the defined archetype string values.
- [ ] **Task 2: Frontend - `ArchetypeCard.tsx` Component (Next.js 15.3.3 & React 19.1.0)**
    - [ ] **Subtask 2.1:** Create `ArchetypeCard.tsx` component in `src/components/onboarding/` using React 19.1.0 patterns and Next.js 15.3.3 component structure
    - [ ] **Subtask 2.2:** Implement component with TypeScript 5.5.3 strict typing and proper props interface (`title`, `description`, `icon`, `isSelected`, `onSelect`, `className`)
    - [ ] **Subtask 2.3:** Apply Tailwind CSS 4.1.8 styling including text shadows for titles and comprehensive dark mode support
    - [ ] **Subtask 2.4:** Integrate DaisyUI 5.0.43 card components with accessibility improvements and proper ARIA attributes
    - [ ] **Subtask 2.5:** Implement visual distinction for selected state using DaisyUI button variants and Tailwind hover/focus states
    - [ ] **Subtask 2.6:** Add React 19.1.0 `useOptimistic` hook for immediate visual feedback during selection
- [ ] **Task 3: Frontend - Archetype Selection Page/View UI & Logic (Next.js 15.3.3 App Router)**
    - [ ] **Subtask 3.1:** Implement UI container in `app/(main)/onboarding/page.tsx` using Next.js 15.3.3 App Router patterns with proper Server/Client Component separation
    - [ ] **Subtask 3.2:** Create responsive grid layout using Tailwind CSS 4.1.8 container queries for optimal archetype card display across devices
    - [ ] **Subtask 3.3:** Implement React 19.1.0 state management with `useState` and `useOptimistic` for immediate selection feedback
    - [ ] **Subtask 3.4:** Add selection logic ensuring only one archetype can be selected at a time with smooth transitions using React 19.1.0 concurrent features
    - [ ] **Subtask 3.5:** Implement "Continue" button using DaisyUI 5.0.43 button components with proper loading and disabled states
    - [ ] **Subtask 3.6:** Integrate React 19.1.0 Actions API for form submission:
        - [ ] Create server action for `PUT /api/users/me` archetype update
        - [ ] Implement optimistic updates for immediate UI feedback
        - [ ] Handle navigation to next onboarding step using Next.js 15.3.3 navigation patterns
    - [ ] **Subtask 3.7:** Add comprehensive error handling with user-friendly error messages using DaisyUI alert components
- [ ] **Task 3.5: State Management Integration (Zustand 5.0.5 & React Hook Form 7.57.0)**
    - [ ] **Subtask 3.5.1:** Create SSR-compatible Zustand store for user profile management with proper TypeScript interfaces
    - [ ] **Subtask 3.5.2:** Implement React Hook Form 7.57.0 integration with TypeScript-first form schema for archetype selection
    - [ ] **Subtask 3.5.3:** Add form validation rules and error handling using React Hook Form's validation system
    - [ ] **Subtask 3.5.4:** Integrate Zustand store with form state for optimistic updates and global state synchronization
    - [ ] **Subtask 3.5.5:** Ensure proper SSR hydration handling for Zustand store to prevent hydration mismatches
- [ ] **Task 4: Content Finalization**
    - [ ] Ensure final, engaging descriptions for each of the four Fantasy Manager Archetypes are available and used in the `ArchetypeCard` components.
- [ ] **Task 5: Comprehensive Testing Strategy (Jest 29.7.0, Playwright 1.52.0, React Testing Library 16.3.0)**
    - [ ] **Subtask 5.1: Unit Testing - ArchetypeCard Component**
        - [ ] Test component rendering with different props using React Testing Library 16.3.0
        - [ ] Test selection behavior and visual state changes
        - [ ] Test accessibility features (ARIA attributes, keyboard navigation)
        - [ ] Test dark mode styling and responsive behavior
        - [ ] Mock icon components and test prop passing
    - [ ] **Subtask 5.2: Unit Testing - Selection Page Logic**
        - [ ] Test archetype selection state management with React Testing Library
        - [ ] Test form validation using React Hook Form test utilities
        - [ ] Test Zustand store integration with proper mocking
        - [ ] Test optimistic updates and error handling
        - [ ] Test navigation logic after successful selection
    - [ ] **Subtask 5.3: Integration Testing - API Endpoints**
        - [ ] Test `PUT /api/users/me` endpoint for `selectedArchetype` updates
        - [ ] Test API error handling and response validation
        - [ ] Test authentication and authorization for profile updates
        - [ ] Test data persistence and retrieval
    - [ ] **Subtask 5.4: E2E Testing - Complete Onboarding Flow (Playwright 1.52.0)**
        - [ ] Test full archetype selection flow from page load to completion
        - [ ] Test responsive design across different viewport sizes
        - [ ] Test accessibility compliance using Playwright's accessibility testing
        - [ ] Test dark mode functionality end-to-end
        - [ ] Test error scenarios and recovery flows
        - [ ] Test navigation to next onboarding step based on archetype selection
    - [ ] **Subtask 5.5: Accessibility Testing**
        - [ ] Test keyboard navigation through archetype cards
        - [ ] Test screen reader compatibility with ARIA labels
        - [ ] Test color contrast compliance in both light and dark modes
        - [ ] Test focus management and visual focus indicators

- [ ] **Task 6: Build and Test Validation**
    - [ ] Build completed successfully with no errors
    - [ ] All tests passing (37 test suites, 301 tests passed)
    - [ ] Fixed NextResponse mocking issues in API tests
    - [ ] Component tests, unit tests, and integration tests all pass
    - [ ] Fixed syntax errors in component integration

- [ ] **Task 7: Story Completion**
    - [ ] All acceptance criteria met
    - [ ] Fantasy Manager Archetype selection interface accessible during onboarding
    - [ ] All four archetypes displayed with engaging descriptions and selection functionality
    - [ ] Proper loading states, error handling, and accessibility features implemented
    - [ ] Story marked as Complete following BMAD methodology

## Dev Technical Guidance

- **Frontend (Next.js 15.3.3 & React 19.1.0):**
    - **Component Architecture:** Use React 19.1.0 Server Components where appropriate for static archetype data, with Client Components for interactive selection logic
    - **Actions API:** Leverage React 19.1.0 Actions API for form submission and archetype selection persistence
    - **Concurrent Features:** Utilize React 19.1.0 concurrent features for smooth UI transitions during selection
    - **Next.js App Router:** Ensure proper integration with Next.js 15.3.3 App Router patterns in `app/(main)/onboarding/page.tsx`
    - **Component Location:** Place `ArchetypeCard.tsx` in `src/components/onboarding/` following Next.js 15.3.3 component organization patterns
    - **State Management:** Use React 19.1.0 `useState` with optimistic updates for immediate UI feedback during selection
    - **Global State (Zustand 5.0.5):** Implement SSR-compatible user profile store for archetype persistence across onboarding flow
    - **Form Management (React Hook Form 7.57.0):** Use TypeScript-first form handling for archetype selection with proper validation

- **Styling (Tailwind CSS 4.1.8 & DaisyUI 5.0.43):**
    - **Modern Tailwind Features:** Utilize Tailwind CSS 4.1.8 text shadows (`text-shadow-*`) for engaging card titles
    - **Dark Mode Support:** Implement comprehensive dark mode using Tailwind CSS 4.1.8 dark mode utilities (`dark:*`)
    - **DaisyUI Components:** Leverage DaisyUI 5.0.43 card component (`card`, `card-body`, `card-title`) with accessibility improvements
    - **Interactive States:** Use DaisyUI 5.0.43 button variants (`btn-primary`, `btn-outline`) with Tailwind hover and focus states
    - **Responsive Design:** Apply Tailwind CSS 4.1.8 container queries and responsive utilities for optimal mobile experience

- **Component Implementation:**
    - **ArchetypeCard.tsx Props Interface:**
      ```typescript
      interface ArchetypeCardProps {
        title: string;
        description: string;
        icon: React.ComponentType<{ className?: string }>;
        isSelected: boolean;
        onSelect: () => void;
        className?: string;
      }
      ```
    - **Selection State Management:** Use React 19.1.0 `useOptimistic` hook for immediate visual feedback
    - **Accessibility:** Implement ARIA attributes following DaisyUI 5.0.43 accessibility patterns

- **State Management (Zustand 5.0.5 SSR-Compatible):**
    - **User Profile Store:** Create SSR-compatible Zustand store for user profile data:
      ```typescript
      interface UserProfileStore {
        profile: UserProfile | null;
        selectedArchetype: string | null;
        setSelectedArchetype: (archetype: string) => void;
        updateProfile: (updates: Partial<UserProfile>) => Promise<void>;
        isLoading: boolean;
        error: string | null;
      }
      ```
    - **SSR Hydration:** Use Zustand's `persist` middleware with proper SSR hydration handling
    - **Optimistic Updates:** Implement optimistic state updates for immediate UI feedback during archetype selection

- **Form Management (React Hook Form 7.57.0 TypeScript):**
    - **Form Schema:** Define TypeScript-first form schema for archetype selection:
      ```typescript
      interface ArchetypeFormData {
        selectedArchetype: 'Eager Learner' | 'Calculated Strategist' | 'Bold Playmaker' | 'Busy Optimizer';
      }
      ```
    - **Validation:** Use React Hook Form's built-in validation with custom validation rules
    - **Form State:** Leverage `useForm` hook with TypeScript generics for type-safe form handling
    - **Error Handling:** Implement comprehensive form error handling with user-friendly messages

- **Testing Strategy (Jest 29.7.0, Playwright 1.52.0, React Testing Library 16.3.0):**
    - **Unit Testing Best Practices:**
      - Use React Testing Library 16.3.0 for component testing with user-centric queries
      - Mock external dependencies (Zustand store, API calls) using Jest 29.7.0 mocking capabilities
      - Test component behavior rather than implementation details
      - Include accessibility testing in unit tests using `@testing-library/jest-dom`
    - **Integration Testing Patterns:**
      - Test API endpoints with proper request/response validation
      - Use MSW (Mock Service Worker) for realistic API mocking
      - Test database interactions and data persistence
      - Validate error handling and edge cases
    - **E2E Testing with Playwright 1.52.0:**
      - Test complete user journeys from archetype selection to next step
      - Include cross-browser testing (Chrome, Firefox, Safari)
      - Test responsive design and mobile interactions
      - Use Playwright's built-in accessibility testing features
      - Implement visual regression testing for UI consistency
    - **Accessibility Testing Requirements:**
      - Keyboard navigation testing for all interactive elements
      - Screen reader compatibility validation
      - Color contrast compliance testing
      - Focus management and ARIA attribute validation

- **Backend:**
    - The `/api/users/me` endpoint from Story 1.4 should already support partial updates to `UserProfile`. Ensure it correctly handles the `selectedArchetype` field.
- **Data Models:** Refer to `Architecture.md` for the `UserProfile` data model and the specific enum/type for `selectedArchetype`.
- **Content:** Archetype descriptions should be provided or finalized by the PM/PO if placeholder text was used in initial designs.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks, v0.io step, tech guidance | Bob (SM)   |
| Updated Library References               | 2025-06-07 | 1.1     | Added Next.js 15.3.3, React 19.1.0, Tailwind CSS 4.1.8, DaisyUI 5.0.43 patterns | Sarah (PO) |
| Updated State Management                 | 2025-06-07 | 1.2     | Added Zustand 5.0.5 SSR patterns, React Hook Form 7.57.0 TypeScript integration | Sarah (PO) |
| Updated Testing Strategy                 | 2025-06-07 | 1.3     | Added comprehensive testing with Jest 29.7.0, Playwright 1.52.0, accessibility testing | Sarah (PO) |