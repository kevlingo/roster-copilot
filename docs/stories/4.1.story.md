# Story 4.1: Generate Personalized Weekly Strategy Digest

## Status: Approved

## Epic: 4 - AI-Driven In-Season Strategic Guidance MVP (Roster Copilot)

## Story

- As an active **Roster Copilot** user, I want to receive a personalized "Weekly Strategy Digest" from the AI Copilot so that I can get timely advice on waiver targets and start/sit decisions tailored to my team and preferences.

## Acceptance Criteria (ACs)

1.  The system generates a "Personalized Weekly Strategy Digest" for each user. For PoC, this generation can be triggered manually by the user (e.g., via a button in the AI Copilot Panel or on the `/copilot/digest` page) or on a simple schedule (e.g., once when `League_PoC.currentSeasonWeek` advances), using the static dataset's current week.
2.  The digest includes AI Copilot-identified top waiver wire targets based on:
    * User's team needs (`FantasyTeam_PoC.playerIds_onRoster`, `League_PoC.rosterSettings`).
    * User's `UserProfile` preferences (`riskComfortLevel`, `learnedObservations`, etc.).
    * Available `NFLPlayer` static data (unowned players in the league).
3.  The digest includes AI Copilot-recommended start/sit options for key lineup decisions for the upcoming `League_PoC.currentSeasonWeek`, considering:
    * Player matchups (from static `NFLGame` data).
    * User's `UserProfile` preferences.
    * User's current roster and set lineup (from Story 1.10).
4.  Each piece of advice (waiver target, start/sit option) is presented with a concise, preference-driven explanation (leveraging logic from Story 4.5: "Preference-Driven Explanation Style").
5.  The digest may also include brief highlights of important strategic considerations or matchup advantages/disadvantages for the upcoming week, based on static PoC data.
6.  The digest is accessible via:
    * A notification and summary in the AI Copilot Panel (e.g., using `DigestSummaryItem.tsx` as per v0.io prompt Story 5).
    * A link on the main dashboard (`app/(main)/dashboard/page.tsx`).
    * A dedicated "Weekly Strategy Digest Screen" (`app/(main)/copilot/digest/page.tsx` - path updated for Roster Copilot).
7.  Content is generated by the "AI Copilot Service" using static PoC datasets.
8.  The digest is presented in a clear, scannable, and engaging format (e.g., "Insight Cards" as per `UIUX_Spec.md`).

## Tasks / Subtasks

- [ ] **Task 1: Backend ("AI Copilot Service") - Digest Content Generation Logic**
    - [ ] **Subtask 1.1:** Design PoC logic for identifying top waiver targets (e.g., highest `projectedPoints` among available players for positions of need, filtered by basic `UserProfile` preferences like avoiding players from `teamsToAvoidPlayersFrom`).
    - [ ] **Subtask 1.2:** Design PoC logic for recommending start/sit options (e.g., comparing `projectedPoints` of players on roster for a position, considering `NFLPlayer.status` and simple matchup factors from `NFLGame.matchupContextNotes`).
    - [ ] **Subtask 1.3:** Design PoC logic for generating brief strategic highlights.
    - [ ] **Subtask 1.4:** Implement functions in "AI Copilot Service" to generate these content pieces, incorporating preference-driven explanation styles (from Story 4.5 logic).
- [ ] **Task 2: Backend - API Endpoint for Weekly Digest (`GET /api/copilot/weekly-digest`)**
    - [ ] Create API Route Handler (e.g., `app/api/copilot/weekly-digest/route.ts`).
    - [ ] Endpoint must be protected, requiring an authenticated user.
    - [ ] Input: `userId` (from session), `leagueId` (if applicable, or derives from user's primary league), `weekNumber` (`League_PoC.currentSeasonWeek`).
    - [ ] Call the "AI Copilot Service" to generate the digest content.
    - [ ] Return the structured digest content (waiver targets, start/sit advice, highlights, explanations).
    - [ ] Apply core API middleware.
- [ ] **Task 3: Frontend - "Weekly Strategy Digest" Page/View UI & Logic (`app/(main)/copilot/digest/page.tsx`)**
    - [ ] **Subtask 3.1:** Use the v0.io prompt (section related to `/mentor/digest` - now `/copilot/digest` - page: "Key Elements: Sections for waiver targets, start/sit advice... Likely presented using 'Insight Cards.'") to generate the initial UI structure.
    - [ ] **Subtask 3.2:** Review and adapt generated code. Ensure adherence to `Frontend-Architecture.md`.
    - [ ] **Subtask 3.3:** Implement UI elements (e.g., "Insight Cards") to display waiver targets, start/sit advice, explanations, and strategic highlights fetched from the API.
    - [ ] **Subtask 3.4:** Handle API call to fetch digest content.
    - [ ] **Subtask 3.5:** Ensure clear presentation and scannability.
- [ ] **Task 4: Frontend - Digest Summary in AI Copilot Panel**
    - [ ] **Subtask 4.1:** Design and implement a summary view of the latest digest for the AI Copilot Panel (`AIPanel.tsx`).
    - [ ] **Subtask 4.2:** This might use a component like `DigestSummaryItem.tsx` (from v0.io prompt Story 5) to list key insights with a link to the full digest page.
    - [ ] **Subtask 4.3:** Fetch or receive digest summary data when the panel loads or updates.
- [ ] **Task 5: Testing**
    - [ ] Unit tests for backend digest generation logic (waiver selection, start/sit recommendations based on PoC rules).
    - [ ] Unit tests for frontend components displaying digest content.
    - [ ] Integration test for the `/api/copilot/weekly-digest` API endpoint.
    - [ ] E2E test: User navigates to view their Weekly Strategy Digest (either full page or panel summary), verifies personalized advice is displayed with explanations.

- [ ] **Task 6: Build and Test Validation**
    - [ ] Build completed successfully with no errors
    - [ ] All tests passing (37 test suites, 301 tests passed)
    - [ ] Fixed NextResponse mocking issues in API tests
    - [ ] Component tests, unit tests, and integration tests all pass
    - [ ] Fixed syntax errors in component integration

- [ ] **Task 7: Story Completion**
    - [ ] All acceptance criteria met
    - [ ] Weekly Strategy Digest accessible with personalized waiver targets and start/sit advice
    - [ ] Digest summary displayed in AI Copilot Panel with link to full page
    - [ ] Proper loading states, error handling, and accessibility features implemented
    - [ ] Story marked as Complete following BMAD methodology

## Dev Technical Guidance

### **Natural Language Generation & Content Personalization (2025 Best Practices)**
- **Advanced NLG Implementation**: Use contextual understanding and multilingual capabilities for personalized content generation:
  ```typescript
  interface DigestContentGenerator {
    generateWaiverAnalysis(user: UserProfile, availablePlayers: NFLPlayer[]): PersonalizedContent;
    generateStartSitAdvice(user: UserProfile, roster: NFLPlayer[], matchups: NFLGame[]): PersonalizedContent;
    generateStrategicHighlights(user: UserProfile, weekContext: WeekContext): PersonalizedContent;
  }

  class PersonalizedDigestService implements DigestContentGenerator {
    async generateWaiverAnalysis(user: UserProfile, availablePlayers: NFLPlayer[]): Promise<PersonalizedContent> {
      const filteredPlayers = this.filterByUserPreferences(availablePlayers, user);
      const rankedTargets = this.rankByPersonalizedCriteria(filteredPlayers, user);

      return {
        content: await this.generateNLGContent(rankedTargets, user.preferredExplanationDepth),
        confidence: this.calculateConfidenceScore(rankedTargets),
        personalizationFactors: this.extractPersonalizationFactors(user)
      };
    }
  }
  ```
- **LLM Integration (Gemini 2025)**: Implement sophisticated prompt engineering for contextual content generation:
  ```typescript
  const generatePersonalizedPrompt = (user: UserProfile, context: DigestContext) => {
    return `[FANTASY FOOTBALL ADVISOR CONTEXT]
    User Archetype: ${user.selectedArchetype}
    Risk Tolerance: ${user.riskComfortLevel}
    Explanation Style: ${user.preferredExplanationDepth}
    Team Needs: ${context.positionalNeeds}
    Week Context: ${context.weekNumber}

    Generate personalized waiver wire analysis focusing on:
    - ${user.selectedArchetype === 'Eager Learner' ? 'Educational explanations with learning opportunities' : ''}
    - ${user.riskComfortLevel === 'aggressive' ? 'High-upside players with boom potential' : 'Consistent, reliable options'}
    - ${user.preferredExplanationDepth === 'detailed' ? 'In-depth statistical analysis' : 'Concise, actionable insights'}

    [GENERATE PERSONALIZED RECOMMENDATIONS]`;
  };
  ```
- **Recommendation Algorithms**: Implement multi-factor recommendation engine with user preference weighting
- **Content Scalability**: Handle large volumes of personalized content with efficient caching and generation strategies

### **Insight Card UI Patterns & Data Visualization (React/TypeScript 2025)**
- **Atomic Design Implementation**: Create modular, reusable insight card components with TypeScript type safety:
  ```typescript
  interface InsightCardProps<T extends DigestItem> {
    data: T;
    visualConfig: VisualConfig;
    interactionMode: 'summary' | 'detailed' | 'interactive';
    onCardAction?: (action: CardAction) => void;
  }

  const InsightCard = <T extends DigestItem>({
    data,
    visualConfig,
    interactionMode
  }: InsightCardProps<T>) => {
    const [expanded, setExpanded] = useState(false);

    return (
      <figure
        role="region"
        aria-labelledby={`card-${data.id}-title`}
        className="insight-card"
      >
        <h3 id={`card-${data.id}-title`} className="sr-only">
          {data.title}
        </h3>
        <div className="card-content">
          {interactionMode === 'summary' ? (
            <SummaryView data={data} />
          ) : (
            <DetailedView data={data} expanded={expanded} />
          )}
        </div>
        <figcaption className="sr-only">
          {data.accessibilityDescription}
        </figcaption>
      </figure>
    );
  };
  ```
- **Progressive Disclosure**: Implement staged data loading with React Suspense and error boundaries
- **Accessibility Compliance**: WCAG 2.2 AAA standards with semantic HTML5, keyboard navigation, and screen reader support
- **Performance Optimization**: Memoized chart computations, Web Workers for data aggregation, and lazy-loaded visualization layers

### **Advanced Personalization & User Experience**
- **Dynamic Content Adaptation**: Real-time content adjustment based on user behavior patterns and preferences:
  ```typescript
  const usePersonalizedDigest = (userId: string, weekNumber: number) => {
    return useQuery({
      queryKey: ['digest', userId, weekNumber],
      queryFn: async () => {
        const userProfile = await getUserProfile(userId);
        const digestContent = await generatePersonalizedDigest(userProfile, weekNumber);

        // Apply real-time personalization
        return adaptContentToUserContext(digestContent, userProfile);
      },
      staleTime: 30 * 60 * 1000, // 30 minutes
      refetchOnWindowFocus: false
    });
  };
  ```
- **Cross-Card Filtering**: Shared state management with Zustand for coordinated insight views
- **Contextual Actions**: Right-click menus and hover interactions with card-specific operations
- **Voice-Controlled Insights**: Web Speech API integration for accessibility and modern interaction patterns

### **Performance & Scalability (2025 Standards)**
- **Efficient Content Generation**: Batch processing for multiple users with intelligent caching strategies
- **Real-Time Updates**: WebSocket integration for live digest updates and user preference changes
- **Edge Computing**: Deploy content generation logic closer to users for reduced latency
- **Monitoring**: Real-time analytics for content engagement, personalization effectiveness, and user satisfaction metrics

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

## Current Implementation References (2025)

### **Natural Language Generation & Content Personalization**
- **Advanced NLG**: Contextual understanding with multilingual capabilities for personalized content generation
- **LLM Integration**: Gemini 2025 API with sophisticated prompt engineering and context-aware generation
- **Recommendation Algorithms**: Multi-factor recommendation engine with user preference weighting and confidence scoring
- **Content Scalability**: Efficient batch processing with intelligent caching for large-scale personalization
- **Real-Time Adaptation**: Dynamic content adjustment based on user behavior patterns and preferences

### **Insight Card UI Patterns & Data Visualization**
- **Atomic Design**: Modular, reusable insight card components with TypeScript type safety and progressive disclosure
- **Accessibility Compliance**: WCAG 2.2 AAA standards with semantic HTML5, keyboard navigation, and screen reader support
- **Performance Optimization**: Memoized chart computations, Web Workers for data aggregation, lazy-loaded visualization
- **Interactive Patterns**: Cross-card filtering, contextual actions, and voice-controlled insights via Web Speech API
- **State Management**: Shared Zustand stores for coordinated insight views and real-time updates

### **Advanced Personalization & User Experience**
- **Dynamic Content**: Real-time content adaptation based on user profiles and behavioral patterns
- **Multi-Modal Interaction**: Voice commands, touch gestures, and keyboard navigation for inclusive design
- **Progressive Enhancement**: Staged data loading with React Suspense and comprehensive error boundaries
- **Contextual Intelligence**: AI-assisted layout with self-organizing card grids and predictive state pre-rendering
- **User Preference Learning**: Continuous adaptation based on interaction patterns and explicit feedback

### **Performance & Scalability**
- **Edge Computing**: Content generation logic deployed closer to users for reduced latency
- **Efficient Caching**: Multi-layer caching strategies with intelligent invalidation and refresh policies
- **Real-Time Updates**: WebSocket integration for live digest updates and collaborative features
- **Monitoring**: Comprehensive analytics for content engagement, personalization effectiveness, and user satisfaction
- **Scalable Architecture**: Microservices approach with containerized deployment and auto-scaling capabilities

### Change Log

| Change                                    | Date       | Version | Description                                                    | Author     |
| :---------------------------------------- | :--------- | :------ | :------------------------------------------------------------- | :--------- |
| Formalized by PO (as Roster Mentor)       | 2025-05-31 | 0.1     | Initial formalization                                          | Sarah (PO) |
| Prepared for Dev by SM (Updated to Roster Copilot) | 2025-06-01 | 1.0     | Added detailed tasks, v0.io step, tech guidance, project name | Bob (SM)   |
| Updated with 2025 NLG & personalization best practices | 2025-06-06 | 1.1     | Enhanced content generation, insight cards, advanced personalization | Sarah (PO) |