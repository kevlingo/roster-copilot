# Story 2.3: Develop "Learn-As-You-Go" Mechanism for User Preference Profile Refinement

## Status: Approved

## Epic: 2 - AI Copilot Onboarding & Personalization Foundation MVP

## Story

- As an active user, I want the AI Copilot to observe my actions and decisions, and when it detects patterns or significant deviations from my current User Preference Profile, I want it to proactively ask for my confirmation to update and refine my profile so that its advice becomes increasingly personalized and accurate over time.

## Acceptance Criteria (ACs)

1.  The "AI Copilot Service" (backend logic within Next.js, as per `Architecture.md`) includes a mechanism to "observe" key user actions. For PoC, observed actions are simplified and might include:
    * Analysis of players drafted/added via waivers (e.g., if a user consistently picks players tagged with `keyAttributes.upsidePotential: "High"` when their `riskComfortLevel` is "low").
    * (PoC Stretch) Analysis of lineup choices against projections/risk (e.g., consistently starting high-risk players).
2.  The AI Copilot Service compares observed behaviors against the user's existing `UserProfile` (`selectedArchetype`, `onboardingAnswers`, `learnedObservations`).
3.  (PoC Scope) When a predefined, simplified pattern or deviation is detected (e.g., 2-3 consecutive high-risk waiver claims by a "low-risk" user), the AI Copilot Service generates a contextual refinement prompt.
4.  This refinement prompt is surfaced to the user unobtrusively via the `AIPanel.tsx` (from `UIUX_Spec.md` and v0.io prompt).
5.  The prompt clearly states the observation and asks for confirmation to update preferences (e.g., "I've noticed you've been making some bold waiver claims! Should I adjust your risk profile to consider more high-upside players?").
6.  The user can respond "Yes" / "No" (or similar) via interactive elements within the `AIPanel.tsx`.
7.  If "Yes": The AI Copilot Service (via an API call) updates the `UserProfile` (e.g., adding to `learnedObservations.playerStyleAffinity` or adjusting `riskComfortLevel` or a new numeric `riskToleranceNumeric` field).
8.  If "No": The `UserProfile` is not updated for that observation, and the AI respects this (e.g., by not prompting for the exact same observation too frequently).
9.  The AI Copilot provides brief confirmation of the user's choice within the `AIPanel.tsx`.
10. For PoC, the observation logic and pattern detection are simplified to 1-2 demonstrable scenarios triggered by actions within the static data environment.

## Tasks / Subtasks

- [ ] **Task 1: Backend - Design "Observation" Heuristics & Triggers (AI Copilot Service)**
    - [ ] Define 1-2 simple, detectable patterns for PoC (e.g., "User drafted/added X number of 'high-upside' players despite 'low-risk' profile setting").
    - [ ] Design how user actions (draft picks, waiver adds - from Story 1.8, 1.11 APIs) will be logged or made available to the AI Copilot Service for this analysis. (This might involve the AI Copilot Service itself inspecting team rosters after changes).
- [ ] **Task 2: Backend - Enhanced Pattern Detection & Prompt Generation (AI Copilot Service with Next.js 15.3.3)**
    - [ ] **Subtask 2.1:** Implement AI Copilot Service logic with Next.js 15.3.3 performance optimizations for pattern analysis
    - [ ] **Subtask 2.2:** Add efficient data analysis patterns using better-sqlite3 11.10.0 query optimization
    - [ ] **Subtask 2.3:** Implement intelligent prompt generation with TypeScript 5.5.3 strict typing for AI responses
    - [ ] **Subtask 2.4:** Add performance monitoring for pattern detection algorithms
    - [ ] **Subtask 2.5:** Implement caching strategies for frequently accessed user behavior patterns
- [ ] **Task 3: Backend - API for Refinement Interaction**
    - [ ] Create an API endpoint (e.g., `GET /api/copilot/refinement-prompts`) for the frontend to fetch any pending refinement prompts for the user.
    - [ ] Create an API endpoint (e.g., `POST /api/copilot/refinement-response`) for the frontend to send the user's response (Yes/No and prompt ID). This endpoint will trigger the AI Copilot Service to update `UserProfile` if "Yes".
    - [ ] Apply core API middleware.
- [ ] **Task 4: Backend - Update UserProfile based on Response**
    - [ ] Implement logic in AI Copilot Service (triggered by `POST /api/copilot/refinement-response`) to update `UserProfile.learnedObservations` or other relevant preference fields based on an affirmative user response.
- [ ] **Task 5: Frontend - Enhanced AI Prompt Display & Response Handling (React 19.1.0 & Next.js 15.3.3)**
    - [ ] **Subtask 5.1:** Modernize `AIPanel.tsx` with React 19.1.0 concurrent features for smooth AI prompt rendering
    - [ ] **Subtask 5.2:** Implement React 19.1.0 `useTransition` for non-blocking API calls to `GET /api/copilot/refinement-prompts`
    - [ ] **Subtask 5.3:** Create responsive AI prompt component using Tailwind CSS 4.1.8 advanced styling and text shadows
    - [ ] **Subtask 5.4:** Add DaisyUI 5.0.43 interactive buttons with enhanced hover states and accessibility features
    - [ ] **Subtask 5.5:** Implement React 19.1.0 `useOptimistic` for immediate UI feedback during user responses
    - [ ] **Subtask 5.6:** Add comprehensive error handling with user-friendly DaisyUI alert components
    - [ ] **Subtask 5.7:** Integrate Zustand 5.0.5 for AI prompt state management with SSR compatibility
    - [ ] **Subtask 5.8:** Implement dark mode support for AI prompt interactions using Tailwind CSS 4.1.8
- [ ] **Task 6: Comprehensive Testing Strategy (Jest 29.7.0, Playwright 1.52.0, React Testing Library 16.3.0)**
    - [ ] **Subtask 6.1: Unit Testing - AI Pattern Detection**
        - [ ] Test backend heuristic/pattern detection logic with comprehensive edge cases
        - [ ] Test AI prompt generation algorithms with various user behavior scenarios
        - [ ] Test UserProfile update logic with React Testing Library 16.3.0 patterns
        - [ ] Mock AI service dependencies using Jest 29.7.0 advanced mocking capabilities
    - [ ] **Subtask 6.2: Unit Testing - Frontend AI Components**
        - [ ] Test AIPanel.tsx enhancements with React 19.1.0 concurrent features
        - [ ] Test AI prompt component rendering with different prompt types
        - [ ] Test user response handling and optimistic updates
        - [ ] Test accessibility features for AI prompt interactions
        - [ ] Test dark mode functionality for AI components
    - [ ] **Subtask 6.3: Integration Testing - AI Service APIs**
        - [ ] Test `/api/copilot/refinement-prompts` with comprehensive scenarios
        - [ ] Test `/api/copilot/refinement-response` with validation and error handling
        - [ ] Test AI service performance under various load conditions
        - [ ] Test database integration with better-sqlite3 optimization patterns
    - [ ] **Subtask 6.4: E2E Testing - Complete AI Learning Flow (Playwright 1.52.0)**
        - [ ] Test full user journey from action trigger to preference update
        - [ ] Test AI prompt appearance and user interaction across browsers
        - [ ] Test responsive design for AI prompts on mobile devices
        - [ ] Test accessibility compliance for AI learning interactions
        - [ ] Test performance of AI pattern detection in realistic scenarios
    - [ ] **Subtask 6.5: Performance Testing**
        - [ ] Test AI service response times under various user loads
        - [ ] Test pattern detection algorithm performance with large datasets
        - [ ] Test frontend rendering performance with React 19.1.0 concurrent features
        - [ ] Test database query optimization for user behavior analysis

- [ ] **Task 7: Build and Test Validation**
    - [ ] Build completed successfully with no errors
    - [ ] All tests passing (37 test suites, 301 tests passed)
    - [ ] Fixed NextResponse mocking issues in API tests
    - [ ] Component tests, unit tests, and integration tests all pass
    - [ ] Fixed syntax errors in component integration

- [ ] **Task 8: Story Completion**
    - [ ] All acceptance criteria met
    - [ ] Learn-As-You-Go mechanism observes user actions and detects patterns
    - [ ] AI Copilot proactively asks for confirmation to update user preferences
    - [ ] Proper loading states, error handling, and accessibility features implemented
    - [ ] Story marked as Complete following BMAD methodology

## Dev Technical Guidance

- **Frontend (React 19.1.0 & Next.js 15.3.3):**
    - **Concurrent Features:** Use React 19.1.0 concurrent features for smooth AI prompt rendering and user interaction
    - **Server Components:** Leverage Next.js 15.3.3 Server Components for static AI prompt templates with Client Components for interactive responses
    - **Performance Optimization:** Implement React 19.1.0 `useOptimistic` for immediate UI feedback during preference updates
    - **Component Architecture:** Use React 19.1.0 `useTransition` for non-blocking AI service calls and pattern detection
    - **AIPanel.tsx Enhancement:** Modernize with React 19.1.0 patterns for seamless prompt display and response handling
    - **State Management:** Integrate Zustand 5.0.5 for complex AI observation state with SSR compatibility

- **Styling (Tailwind CSS 4.1.8 & DaisyUI 5.0.43):**
    - **Advanced Styling:** Use Tailwind CSS 4.1.8 text shadows for prominent AI prompts and notifications
    - **Dark Mode:** Comprehensive dark mode support for AI panel interactions and preference displays
    - **Responsive Design:** Advanced responsive patterns for AI prompts across all device sizes
    - **Interactive States:** Enhanced hover and focus states for AI prompt action buttons using DaisyUI 5.0.43
    - **Accessibility:** ARIA attributes and keyboard navigation for AI prompt interactions

- **Modern Component Patterns:**
    - **AI Prompt Component Interface:**
      ```typescript
      interface AIPromptProps {
        prompt: RefinementPrompt;
        onResponse: (response: 'yes' | 'no') => void;
        isLoading?: boolean;
        className?: string;
      }
      ```
    - **Concurrent Rendering:** Use React 19.1.0 concurrent features for smooth AI service integration
    - **Error Boundaries:** Implement modern error boundaries for AI service failures
    - **Performance Monitoring:** Add React 19.1.0 performance profiling for AI pattern detection

- **Enhanced Testing Strategy (Jest 29.7.0, Playwright 1.52.0, React Testing Library 16.3.0):**
    - **AI Service Testing Best Practices:**
      - Use Jest 29.7.0 for comprehensive AI pattern detection algorithm testing
      - Mock external AI services and user behavior data for consistent testing
      - Test AI prompt generation with various user profile configurations
      - Include performance testing for pattern detection under load
    - **Frontend AI Component Testing:**
      - Use React Testing Library 16.3.0 for AI prompt component testing
      - Test React 19.1.0 concurrent features with proper async handling
      - Test user interaction flows with AI prompts and responses
      - Include accessibility testing for AI learning interface components
    - **Integration Testing Patterns:**
      - Test AI service API endpoints with realistic user behavior data
      - Use MSW (Mock Service Worker) for AI service API mocking
      - Test database interactions for user behavior analysis and storage
      - Validate AI prompt delivery and user response processing
    - **E2E Testing with Playwright 1.52.0:**
      - Test complete AI learning user journeys across different scenarios
      - Include cross-browser testing for AI prompt interactions
      - Test responsive design for AI components on various devices
      - Use Playwright's accessibility testing for AI learning compliance
      - Implement visual regression testing for AI prompt UI consistency
    - **Performance Testing Requirements:**
      - AI service response time validation under various loads
      - Pattern detection algorithm performance with large user datasets
      - Frontend rendering performance with React 19.1.0 optimizations
      - Database query performance for user behavior analysis

- **Backend (AI Copilot Service):**
    - The core challenge for PoC is defining *simple but demonstrable* heuristics. Avoid over-engineering pattern detection.
    - Logging user actions for analysis: This could be a separate logging mechanism or the AI Copilot service could query team rosters/transaction logs after certain events. For PoC, direct analysis of current roster state post-waiver might be simplest.
    - `UserProfile` updates should be specific (e.g., adding a tag to `learnedObservations`).
- **Data Models:** Refer to `Architecture.md` for `UserProfile` (especially `selectedArchetype`, `onboardingAnswers`, `learnedObservations`, and potentially new fields like `riskToleranceNumeric`).
- **API Design:** Ensure APIs for fetching prompts and sending responses are lightweight.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks and tech guidance          | Bob (SM)   |
| Updated Modern Component Patterns         | 2025-06-07 | 1.1     | Added React 19.1.0 concurrent features, Next.js 15.3.3 optimizations, Tailwind CSS 4.1.8 | Sarah (PO) |
| Updated Enhanced Testing                  | 2025-06-07 | 1.2     | Added comprehensive AI testing with Jest 29.7.0, Playwright 1.52.0, performance testing | Sarah (PO) |