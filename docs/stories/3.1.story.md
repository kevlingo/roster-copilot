# Story 3.1: Deliver Real-Time Personalized Player Recommendations during Draft

## Status: Approved

## Epic: 3 - AI-Powered Draft Assistance MVP (Draft Day Co-Pilot)

## Story

- As a user participating in a live draft, I want to receive real-time, personalized player recommendations from the AI Copilot (Draft Day Co-Pilot) when it's my turn to pick, so that I can make informed decisions that align with my preferences and team needs.

## Acceptance Criteria (ACs)

1.  When it is the user's turn to pick in the "Live Draft Room" (Story 1.8, UI at `app/(main)/draft/[leagueId]/page.tsx`), the AI Co-Pilot panel area (integrated into the Draft Room UI, potentially using `AIPanel.tsx` from v0.io prompt) displays personalized player recommendations.
2.  Recommendations are generated by the "AI Copilot Service" (`Architecture.md`) considering:
    * User's `UserProfile` (`selectedArchetype`, `onboardingAnswers`, `learnedObservations`).
    * Current draft state (all picks made, available players, current round/pick number).
    * User's current team composition and positional needs based on `League_PoC.rosterSettings`.
    * Available `NFLPlayer` static data.
3.  For each recommended player, the AI Co-Pilot panel displays essential context: `fullName`, `position`, `nflTeamAbbreviation`, `projectedPoints` (from `NFLPlayer` data).
4.  The AI provides a concise, preference-driven explanation for each recommendation (leveraging logic from Story 4.5: "Preference-Driven Explanation Style").
5.  Recommendations are generated and displayed within the NFR target of 3-5 seconds from when the user's pick turn becomes active.
6.  For PoC, recommendations are generated once when the user's turn begins. Dynamic updates if other players are picked just before the user (requiring sub-second regeneration) are out of scope for MVP.
7.  Recommendations are presented clearly within the AI Co-Pilot panel.
8.  PoC: "AI Copilot Service" uses simplified logic and static `NFLPlayer` dataset with `UserProfile` to generate recommendations.
9.  The UI allows users to ignore AI suggestions and make their own pick (ensured by Story 3.3). This story focuses on recommendation delivery.

## Tasks / Subtasks

- [ ] **Task 1: Backend - AI Copilot Service: Draft Recommendation Logic**
    - [ ] **Subtask 1.1:** Design simplified PoC logic for personalized recommendations within "AI Copilot Service."
        - [ ] Consider `UserProfile.selectedArchetype` (e.g., "Eager Learner" might get safer picks, "Bold Playmaker" higher risk/reward).
        - [ ] Consider `UserProfile.onboardingAnswers.riskComfortLevel`.
        - [ ] Factor in team positional needs based on `League_PoC.rosterSettings` and players already drafted by the user.
        - [ ] Use `NFLPlayer.projectedPoints` and `keyAttributes` as primary data points.
    - [ ] **Subtask 1.2:** Implement the recommendation generation function in the AI Copilot Service. Input: `userId`, draft state (picks made, available players), user's current roster. Output: List of 1-2 recommended `NFLPlayer` objects with a generated rationale string for each.
    - [ ] **Subtask 1.3:** Integrate "Preference-Driven Explanation Style" (from Story 4.5 logic) into rationale generation.
- [ ] **Task 2: Backend - API Endpoint for Draft Advice (`POST /api/copilot/draft-advice`)**
    - [ ] Create/Update API Route Handler at `app/api/copilot/draft-advice/route.ts`.
    - [ ] Endpoint must be protected, requiring an authenticated user.
    - [ ] Input: Current draft state (e.g., all picks made so far, current round/pick, potentially list of available players if not derived server-side).
    - [ ] Call the AI Copilot Service's recommendation logic.
    - [ ] Return the list of recommended players and their explanations.
    - [ ] Ensure response time aligns with NFR (backend processing part).
    - [ ] Apply core API middleware.
- [ ] **Task 3: Frontend - Display Recommendations in AI Co-Pilot Panel (Draft Room)**
    - [ ] **Subtask 3.1:** When it's the user's pick turn on `app/(main)/draft/[leagueId]/page.tsx`, trigger an API call to `POST /api/copilot/draft-advice` with the necessary draft state payload.
    - [ ] **Subtask 3.2:** On receiving the API response, populate the AI Co-Pilot panel area (potentially using `AIPanel.tsx` or a dedicated component within it) with the recommended players and their explanations.
    - [ ] **Subtask 3.3:** For each recommendation, display player context (`fullName`, `position`, `team`, `projectedPoints`). Use a consistent player card format (perhaps a variant of `DraftPlayerCard.tsx`).
    - [ ] **Subtask 3.4:** Handle loading state while advice is being fetched and error states if the API call fails.
    - [ ] **Subtask 3.5:** Ensure the display is clear, scannable, and fits within the panel design.
- [ ] **Task 4: Testing**
    - [ ] Unit tests for the recommendation generation logic in AI Copilot Service (test with different user profiles and draft states).
    - [ ] Unit tests for rationale/explanation generation.
    - [ ] Integration test for the `/api/copilot/draft-advice` API endpoint.
    - [ ] E2E test: User's turn begins in the draft room; AI Co-Pilot panel loads and displays personalized player recommendations with context and explanations within the target time.

- [ ] **Task 5: Build and Test Validation**
    - [ ] Build completed successfully with no errors
    - [ ] All tests passing (37 test suites, 301 tests passed)
    - [ ] Fixed NextResponse mocking issues in API tests
    - [ ] Component tests, unit tests, and integration tests all pass
    - [ ] Fixed syntax errors in component integration

- [ ] **Task 6: Story Completion**
    - [ ] All acceptance criteria met
    - [ ] AI Copilot provides personalized draft advice during user's turn
    - [ ] Recommendations displayed with player context and explanations
    - [ ] Proper loading states, error handling, and accessibility features implemented
    - [ ] Story marked as Complete following BMAD methodology

## Dev Technical Guidance

- **Backend (AI Copilot Service):**
    - Focus on simple, rule-based personalization for PoC. For example:
        - If "Eager Learner," suggest players with high `keyAttributes.consistencyRating`.
        - If "Bold Playmaker," suggest players with high `keyAttributes.upsidePotential`.
        - Prioritize filling core starting positions first.
    - If using Gemini or another LLM for rationale generation, craft prompts carefully, providing `UserProfile` snippets and player data.
- **Frontend:**
    - The AI Co-Pilot panel UI is part of the Draft Room. The v0.io prompt for the Draft Room included a placeholder for this panel. The Developer Agent will need to implement the content display within this area.
    - Performance: Optimizing the API call and frontend rendering is crucial to meet the 3-5 second NFR.
- **Data Models:** Refer to `Architecture.md` for `UserProfile`, `NFLPlayer`, `League_PoC`.
- **Sequence Diagram:** The "User Requesting and Receiving Draft Advice" sequence diagram in `Architecture.md` outlines this flow.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks and tech guidance          | Bob (SM)   |