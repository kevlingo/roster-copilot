# Story 2.2: Core Conversational Guided Questionnaire for Eager Learner

## Status: Approved

## Epic: 2 - AI Copilot Onboarding & Personalization Foundation MVP

## Story

- As a new user who has selected the "Eager Learner" archetype, I want to continue the conversation with a basic guided questionnaire so that the AI Copilot can establish my essential baseline preferences for personalized advice.

## Acceptance Criteria (ACs)

1.  When a user selects "Eager Learner" archetype in Story 2.1, the AI Copilot seamlessly continues the conversation with the guided questionnaire without requiring page navigation or UI changes.
2.  The AI Copilot introduces the questionnaire purpose conversationally (e.g., "Perfect! Since you're eager to learn, I'd like to ask a few quick questions to personalize my advice for you.").
3.  The questionnaire consists of 2-3 key questions presented conversationally, designed to capture baseline preferences as defined in `Architecture.md#UserProfile`:
    * `preferredExplanationDepth` - Asked conversationally (e.g., "When I explain strategies, would you prefer: 1) Simple and quick, 2) Standard detail, or 3) Deep dive explanations?")
    * `riskComfortLevel` - Asked conversationally (e.g., "How do you feel about taking risks with your lineup? 1) Play it safe, 2) Balanced approach, or 3) Go big or go home?")
    * Optional third question based on PM/PO definition, presented in conversational format.
4.  Each question allows for natural language responses (number selection, option names, or conversational answers that can be mapped to the defined options).
5.  The AI Copilot confirms each answer and provides encouraging feedback before moving to the next question.
6.  Upon completion of all questions, the AI Copilot summarizes the user's preferences and confirms the setup is complete.
7.  The user's answers are persisted to the user's `UserProfile.onboardingAnswers` object via an API call to `PUT /api/users/me`.
8.  After successful persistence, the AI Copilot provides next steps and transitions the user to the main application or next onboarding phase.
9.  The conversational flow handles edge cases (unclear responses, requests to change previous answers, technical errors) with friendly, helpful responses.

## Dependencies

- **Prerequisite:** Story 2.1 (Core Conversational Archetype Selection) must be completed
- **Integration:** Seamlessly continues conversation from Story 2.1 for Eager Learner users

## Tasks / Subtasks

- [ ] **Task 1: Backend - Onboarding Answers Capability**
    - [ ] Verify `PUT /api/users/me` endpoint accepts `UserProfile.onboardingAnswers` object updates
    - [ ] Ensure backend validation for questionnaire response values

- [ ] **Task 2: Questionnaire Conversation Scripts**
    - [ ] Create questionnaire introduction and transition scripts from archetype selection
    - [ ] Design conversational question formats for explanation depth and risk comfort preferences
    - [ ] Create confirmation and summary scripts for questionnaire completion

- [ ] **Task 3: Question Flow Integration**
    - [ ] Extend Story 2.1 conversation state management for questionnaire flow
    - [ ] Implement seamless transition from archetype selection to questionnaire
    - [ ] Add questionnaire context tracking and progress management

- [ ] **Task 4: Response Processing and Mapping**
    - [ ] Implement natural language processing for questionnaire responses
    - [ ] Create response validation and mapping to preference values
    - [ ] Handle question sequencing and answer confirmation logic

- [ ] **Task 5: API Integration for Answers**
    - [ ] Connect questionnaire completion to `PUT /api/users/me` for `onboardingAnswers` persistence
    - [ ] Implement API call triggers on questionnaire completion
    - [ ] Add error handling for questionnaire API failures

- [ ] **Task 6: Conversation Completion**
    - [ ] Implement questionnaire completion detection and summary
    - [ ] Create transition logic to main application after questionnaire
    - [ ] Handle conversation state cleanup after successful completion

- [ ] **Task 7: Basic Error Handling**
    - [ ] Add user-friendly error messages for unclear questionnaire responses
    - [ ] Implement retry logic for failed questionnaire API calls
    - [ ] Create fallback responses for unrecognized questionnaire inputs

- [ ] **Task 8: Testing**
    - [ ] Write unit tests for questionnaire flow logic and response processing
    - [ ] Write integration tests for `PUT /api/users/me` onboarding answers updates
    - [ ] Write E2E test for complete Eager Learner questionnaire flow

- [ ] **Task 9: Build and Test Validation**
    - [ ] Build completed successfully with no errors
    - [ ] All tests passing including questionnaire functionality
    - [ ] Integration with Story 2.1 working properly

- [ ] **Task 10: Story Completion**
    - [ ] All acceptance criteria met and validated
    - [ ] Core conversational questionnaire functional for Eager Learner users
    - [ ] Story marked as Complete following BMAD methodology

## Dev Technical Guidance

### **Conversational AI State Management (2025 Best Practices)**
- **Hybrid State Architecture**: Combine Zustand for client-side conversation state with TanStack Query for server-side NLP processing:
  ```typescript
  interface QuestionnaireState {
    currentStep: number;
    responses: Map<string, string>;
    validationErrors: string[];
    conversationHistory: Array<{ role: 'user' | 'bot'; content: string; timestamp: Date }>;
    nlpAnalysis?: { intent: string; confidence: number; entities: Record<string, any> };
  }
  ```
- **Context-Aware Dialogues**: Maintain conversation history for contextual responses and dynamic question branching
- **Session Persistence**: Use sessionStorage with TTL policies for conversation state recovery
- **Type-Safe Flow Control**: Define questionnaire steps with TypeScript interfaces for validation and navigation

### **Natural Language Processing & Response Mapping**
- **User Preference Validation**: Implement Zod schemas for type-safe preference mapping:
  ```typescript
  const OnboardingAnswersSchema = z.object({
    preferredExplanationDepth: z.enum(['simple', 'standard', 'detailed']),
    riskComfortLevel: z.enum(['conservative', 'balanced', 'aggressive']),
    learningStyle: z.enum(['visual', 'analytical', 'hands-on']).optional()
  });

  type OnboardingAnswers = z.infer<typeof OnboardingAnswersSchema>;
  ```
- **Response Processing**: Implement boundary-layer validation with safeParse for questionnaire inputs
- **Intent Recognition**: Basic NLP for mapping natural language responses to preference values
- **Confirmation Logic**: Multi-step validation with user confirmation before persistence

### **Conversation Flow & Integration**
- **Seamless Transitions**: Extend Story 2.1 conversation state for questionnaire continuation
- **Dynamic Branching**: Conditional question flow based on previous responses and user archetype
- **Progress Tracking**: Visual and conversational progress indicators for user engagement
- **Error Recovery**: Graceful handling of unclear responses with clarification prompts
- **State Cleanup**: Proper conversation state management after questionnaire completion

### **Backend Integration & Data Persistence**
- **API Integration**: Use existing `PUT /api/users/me` endpoint with enhanced validation for `onboardingAnswers`
- **Atomic Updates**: Ensure questionnaire completion updates are atomic and validated
- **Error Handling**: Comprehensive error responses for API failures with retry logic
- **Data Models**: Refer to `Architecture.md` for `UserProfile.onboardingAnswers` structure with type safety

### **Testing & Quality Assurance (2025 Standards)**
- **Conversation Flow Testing**: Unit tests for state transitions and response processing
- **NLP Testing**: Validation of response mapping accuracy and edge cases
- **Integration Testing**: Complete questionnaire flow with API persistence
- **User Experience Testing**: Conversation quality and response time optimization

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

## Current Implementation References (2025)

### **Conversational AI & State Management**
- **Zustand + TanStack Query**: Hybrid architecture for client-side conversation state and server-side NLP processing
- **Context-Aware Dialogues**: Conversation history maintenance for contextual responses and dynamic branching
- **Session Persistence**: sessionStorage with TTL policies for conversation state recovery
- **Type-Safe Flow Control**: TypeScript interfaces for questionnaire steps and validation
- **Intent Recognition**: Basic NLP for mapping natural language responses to preference values

### **User Preference Mapping & Validation**
- **Zod Schema Validation**: Type-safe preference mapping with runtime validation
- **Boundary-Layer Parsing**: safeParse validation at system boundaries for data integrity
- **Conditional Fields**: Dynamic preference structures based on user behavior and responses
- **Atomic Updates**: Transactional questionnaire completion with proper error handling
- **Response Processing**: Multi-step validation with user confirmation before persistence

### **Modern Conversation Patterns**
- **Dynamic Branching**: Conditional question flow based on previous responses and archetype
- **Progress Tracking**: Visual and conversational progress indicators for engagement
- **Error Recovery**: Graceful handling of unclear responses with clarification prompts
- **State Cleanup**: Proper conversation state management after completion
- **Performance Optimization**: Selective re-rendering and NLP result memoization

### **Integration & User Experience**
- **Seamless Transitions**: Continuation from Story 2.1 archetype selection without UI changes
- **API Integration**: Enhanced `PUT /api/users/me` endpoint with comprehensive validation
- **Testing Strategy**: Conversation flow, NLP accuracy, and user experience optimization
- **Accessibility**: WCAG 2.2 compliance for conversational interfaces

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks and tech guidance          | Bob (SM)   |
| Conversational Enhancement Update         | 2025-06-06 | 2.0     | Updated for conversational questionnaire flow  | Curly (PO) |
| Updated with 2025 AI & conversation best practices | 2025-06-06 | 2.1     | Enhanced state management, NLP processing, preference validation | Sarah (PO) |