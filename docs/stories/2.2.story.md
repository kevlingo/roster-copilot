# Story 2.2: Implement Brief Guided Questionnaire for Eager Learner Archetype Users

## Status: Approved

## Epic: 2 - AI Copilot Onboarding & Personalization Foundation MVP

## Story

- As a new user who has selected the "Eager Learner" archetype, I want to answer a brief, guided questionnaire so that the AI Copilot can establish my essential baseline preferences for personalized advice.

## Acceptance Criteria (ACs)

1.  If a user's `UserProfile.selectedArchetype` is "Eager Learner" (confirmed after Story 2.1), they are immediately presented with a short questionnaire (e.g., within the `AIPanel.tsx` on the `/onboarding` page).
2.  The questionnaire consists of 2-3 key questions designed to capture baseline preferences, as defined in `Architecture.md#UserProfile`:
    * `preferredExplanationDepth` (options: "simple," "standard," "detailed").
    * `riskComfortLevel` (options: "low," "medium," "high").
    * (A third question, if defined by PM/PO, e.g., "What aspect of fantasy football are you most interested in learning about?" with predefined options).
3.  Each question is presented clearly with straightforward options for answers (e.g., using DaisyUI radio buttons or select components).
4.  The user's answers are captured by the frontend.
5.  Upon completion/submission of the questionnaire, the answers are persisted to the user's `UserProfile.onboardingAnswers` object via an API call.
6.  The user is informed (e.g., within the `AIPanel.tsx`) that their initial preferences are set.
7.  After completing the questionnaire, the user proceeds to the next step in the onboarding flow (e.g., profile confirmation/explanation of "Learn-As-You-Go" from Story 2.3, or to the main application dashboard `/dashboard`).
8.  The exact question wording and answer options will be finalized as per `UIUX_Spec.md` or content provided by PM/PO.

## Tasks / Subtasks

- [ ] **Task 1: Backend - Enhanced Profile Update with Database Optimization (better-sqlite3 11.10.0)**
    - [ ] **Subtask 1.1:** Verify and enhance `PUT /api/users/me` API endpoint for `UserProfile.onboardingAnswers` object updates
    - [ ] **Subtask 1.2:** Implement better-sqlite3 11.10.0 transaction patterns for atomic questionnaire data updates
    - [ ] **Subtask 1.3:** Add prepared statements for efficient questionnaire data persistence and retrieval
    - [ ] **Subtask 1.4:** Implement JSON column storage optimization for flexible questionnaire answer structure
    - [ ] **Subtask 1.5:** Add comprehensive database error handling with proper rollback mechanisms
    - [ ] **Subtask 1.6:** Ensure backend validation allows for defined option values with database-level constraints
- [ ] **Task 2: Frontend - Questionnaire UI & Logic (React 19.1.0 & Next.js 15.3.3)**
    - [ ] **Subtask 2.1:** Create questionnaire component in `src/components/onboarding/` using React 19.1.0 patterns and TypeScript 5.5.3 strict typing
    - [ ] **Subtask 2.2:** Implement conditional rendering based on "Eager Learner" archetype selection using Zustand store state
    - [ ] **Subtask 2.3:** Design responsive questionnaire UI using DaisyUI 5.0.43 form components with Tailwind CSS 4.1.8 styling
    - [ ] **Subtask 2.4:** Integrate React Hook Form 7.57.0 with TypeScript-first form schema for questionnaire data management
    - [ ] **Subtask 2.5:** Implement React 19.1.0 Actions API for form submission with proper validation and error handling
    - [ ] **Subtask 2.6:** Add comprehensive dark mode support using Tailwind CSS 4.1.8 dark mode utilities
    - [ ] **Subtask 2.7:** Implement "Submit Answers" button with DaisyUI components and proper loading/disabled states
    - [ ] **Subtask 2.8:** Add navigation logic to next onboarding step using Next.js 15.3.3 navigation patterns
    - [ ] **Subtask 2.9:** Handle API loading and error states with user-friendly DaisyUI alert components
- [ ] **Task 3: Content Finalization**
    - [ ] Confirm and document the exact wording for the questionnaire questions and their answer options.
- [ ] **Task 4: Comprehensive Testing Strategy (Jest 29.7.0, Playwright 1.52.0, React Testing Library 16.3.0)**
    - [ ] **Subtask 4.1: Unit Testing - Questionnaire Component**
        - [ ] Test questionnaire rendering for "Eager Learner" archetype using React Testing Library 16.3.0
        - [ ] Test form validation and error handling with React Hook Form test utilities
        - [ ] Test question display and answer selection behavior
        - [ ] Test accessibility features (ARIA attributes, keyboard navigation)
        - [ ] Test dark mode styling and responsive behavior
    - [ ] **Subtask 4.2: Unit Testing - Form Logic & State Management**
        - [ ] Test React Hook Form 7.57.0 integration with proper mocking
        - [ ] Test form submission logic and validation rules
        - [ ] Test Zustand store integration for user profile updates
        - [ ] Test error handling and loading states
        - [ ] Test navigation logic after successful submission
    - [ ] **Subtask 4.3: Integration Testing - API & Database**
        - [ ] Test `PUT /api/users/me` endpoint for `onboardingAnswers` updates
        - [ ] Test better-sqlite3 11.10.0 transaction handling and data persistence
        - [ ] Test database error handling and rollback mechanisms
        - [ ] Test API validation and error responses
        - [ ] Test data retrieval and consistency
    - [ ] **Subtask 4.4: E2E Testing - Complete Questionnaire Flow (Playwright 1.52.0)**
        - [ ] Test full "Eager Learner" questionnaire flow from archetype selection to completion
        - [ ] Test form validation and error scenarios end-to-end
        - [ ] Test responsive design across different viewport sizes
        - [ ] Test accessibility compliance using Playwright's accessibility testing
        - [ ] Test dark mode functionality throughout the questionnaire flow
        - [ ] Test navigation to next onboarding step after questionnaire completion
    - [ ] **Subtask 4.5: Accessibility Testing**
        - [ ] Test keyboard navigation through questionnaire questions
        - [ ] Test screen reader compatibility with form labels and ARIA attributes
        - [ ] Test color contrast compliance in both light and dark modes
        - [ ] Test focus management and visual focus indicators

- [ ] **Task 5: Build and Test Validation**
    - [ ] Build completed successfully with no errors
    - [ ] All tests passing (37 test suites, 301 tests passed)
    - [ ] Fixed NextResponse mocking issues in API tests
    - [ ] Component tests, unit tests, and integration tests all pass
    - [ ] Fixed syntax errors in component integration

- [ ] **Task 6: Story Completion**
    - [ ] All acceptance criteria met
    - [ ] Brief guided questionnaire accessible for Eager Learner archetype users
    - [ ] User preferences captured and persisted to UserProfile.onboardingAnswers
    - [ ] Proper loading states, error handling, and accessibility features implemented
    - [ ] Story marked as Complete following BMAD methodology

## Dev Technical Guidance

- **Frontend (React 19.1.0 & Next.js 15.3.3):**
    - **Component Architecture:** Use React 19.1.0 Server Components for static questionnaire structure with Client Components for form interactions
    - **Actions API Integration:** Leverage React 19.1.0 Actions API for questionnaire submission and data persistence
    - **Conditional Rendering:** Present questionnaire based on `UserProfile.selectedArchetype` using Zustand store state
    - **Modern Form Handling:** Implement React 19.1.0 form actions with proper validation and error handling
    - **Component Location:** Place questionnaire components in `src/components/onboarding/` following Next.js 15.3.3 organization patterns
    - **TypeScript 5.5.3 Strict Typing:** Use strict TypeScript patterns for form data interfaces and validation schemas

- **Styling & UI (Tailwind CSS 4.1.8 & DaisyUI 5.0.43):**
    - **Form Components:** Utilize DaisyUI 5.0.43 form components (`form-control`, `radio`, `label`) with accessibility improvements
    - **Dark Mode Support:** Implement comprehensive dark mode using Tailwind CSS 4.1.8 dark mode utilities
    - **Responsive Design:** Apply Tailwind CSS 4.1.8 responsive utilities for optimal mobile questionnaire experience
    - **Interactive States:** Use DaisyUI button and form variants with Tailwind hover and focus states
    - **Visual Hierarchy:** Apply Tailwind CSS 4.1.8 text shadows and typography utilities for clear question presentation

- **Form Management & Validation:**
    - **React Hook Form 7.57.0:** Implement TypeScript-first form handling with proper validation schemas
    - **Form Interface:**
      ```typescript
      interface QuestionnaireFormData {
        preferredExplanationDepth: 'simple' | 'standard' | 'detailed';
        riskComfortLevel: 'low' | 'medium' | 'high';
        learningFocus?: string; // Optional third question
      }
      ```
    - **Validation Rules:** Use React Hook Form's built-in validation with custom validation for required fields
    - **Error Handling:** Implement comprehensive form error handling with user-friendly DaisyUI alert components

- **Testing Strategy (Jest 29.7.0, Playwright 1.52.0, React Testing Library 16.3.0):**
    - **Unit Testing Best Practices:**
      - Use React Testing Library 16.3.0 for questionnaire component testing with user-centric queries
      - Mock React Hook Form and Zustand dependencies using Jest 29.7.0 mocking capabilities
      - Test form behavior and validation rather than implementation details
      - Include accessibility testing in unit tests using `@testing-library/jest-dom`
    - **Integration Testing Patterns:**
      - Test questionnaire API endpoints with proper request/response validation
      - Use MSW (Mock Service Worker) for realistic API mocking during testing
      - Test better-sqlite3 database interactions and transaction handling
      - Validate error handling and edge cases for questionnaire submission
    - **E2E Testing with Playwright 1.52.0:**
      - Test complete questionnaire user journey from "Eager Learner" selection to completion
      - Include cross-browser testing for questionnaire functionality
      - Test responsive design and mobile questionnaire interactions
      - Use Playwright's built-in accessibility testing for form compliance
      - Implement visual regression testing for questionnaire UI consistency
    - **Accessibility Testing Requirements:**
      - Form navigation testing for all questionnaire elements
      - Screen reader compatibility validation for questions and answers
      - Color contrast compliance testing for form elements
      - Focus management and ARIA attribute validation for questionnaire flow

- **Database Integration (better-sqlite3 11.10.0):**
    - **Transaction Handling:** Use better-sqlite3 11.10.0 transaction patterns for atomic questionnaire data updates:
      ```typescript
      const updateUserProfile = db.transaction((userId: string, answers: OnboardingAnswers) => {
        const stmt = db.prepare('UPDATE users SET onboarding_answers = ? WHERE id = ?');
        return stmt.run(JSON.stringify(answers), userId);
      });
      ```
    - **Performance Optimization:** Implement prepared statements for efficient questionnaire data persistence
    - **Data Persistence Patterns:** Use JSON column storage for flexible questionnaire answer structure
    - **Connection Management:** Leverage better-sqlite3 11.10.0 connection pooling for optimal performance
    - **Error Handling:** Implement comprehensive database error handling with proper rollback mechanisms

- **Backend:**
    - The `PUT /api/users/me` endpoint needs to robustly handle updates to the nested `onboardingAnswers` object within `UserProfile`.
    - **Database Layer:** Implement efficient data persistence using better-sqlite3 11.10.0 transaction patterns
    - **Validation:** Add server-side validation for questionnaire answers before database persistence
    - **Performance:** Use prepared statements and transaction batching for optimal database performance
- **Data Models:** Refer to `Architecture.md` for the `UserProfile` data model, specifically the `onboardingAnswers` structure (`preferredExplanationDepth`, `riskComfortLevel`).
- **Content:** Question and answer text should be easily configurable or sourced from a constants file if not hardcoded.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks and tech guidance          | Bob (SM)   |
| Updated Library References               | 2025-06-07 | 1.1     | Added React 19.1.0, Next.js 15.3.3, Tailwind CSS 4.1.8, TypeScript 5.5.3 patterns | Sarah (PO) |
| Updated Database Integration             | 2025-06-07 | 1.2     | Added better-sqlite3 11.10.0 optimization patterns, transaction handling | Sarah (PO) |
| Updated Testing Strategy                 | 2025-06-07 | 1.3     | Added comprehensive testing with Jest 29.7.0, Playwright 1.52.0, accessibility testing | Sarah (PO) |