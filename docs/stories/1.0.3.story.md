# Story 1.0.3: Setup Core API Middleware

## Status: Approved

## Epic: 1 - Core Platform Foundation & League Engagement MVP

## Story

- As a Developer, I need to set up core API middleware for common concerns like error handling and request logging so that all API endpoints have consistent baseline behavior and observability from the outset.

## Acceptance Criteria (ACs)

1.  Standardized error handling middleware is implemented for all Next.js API routes (in `app/api/`).
    * This middleware catches unhandled errors from API route handlers.
    * It logs detailed error information server-side (e.g., using `console.error` for PoC, or a structured logger if one is introduced early), adhering to the logging strategy in `Architecture.md#error-handling-strategy`.
    * User-facing responses for errors are generic (e.g., `{ "error": "Internal Server Error" }` or similar) and do not leak sensitive information, as per `Architecture.md`.
    * It returns appropriate HTTP status codes (e.g., 500 for unhandled server errors; specific error handlers might return 400s, 401s, etc., but this middleware handles unexpected errors).
2.  Request logging middleware is implemented for all Next.js API routes.
    * This middleware logs key information for each incoming request (e.g., timestamp, HTTP method, path, response status code, request duration).
    * Logged information aligns with the logging strategy in `Architecture.md`.
3.  (Optional, based on upcoming auth story needs) A basic authentication check middleware or a higher-order function (HOF) wrapper for API route handlers is stubbed out or implemented.
    * This stub would prepare for Story 1.2 (User Login) and subsequent authenticated endpoints by providing a placeholder for session/token validation logic.
    * If implemented, it should be easily applicable to protect specific API routes.
4.  The implemented middleware (error handling, request logging) is applied consistently to API routes, perhaps by wrapping route handlers or using a standard Next.js middleware approach if suitable for these concerns in the App Router.
5.  The setup of this core middleware is briefly documented if it involves patterns beyond standard Next.js API route handler composition (e.g., in a `docs/backend-setup.md` or the main `README.md`).

## Tasks / Subtasks

- [ ] **Task 1:** Research Next.js App Router Middleware/Handler Composition
    - [ ] Investigate best practices for implementing global-like error handling and request logging for API Route Handlers in the Next.js App Router (e.g., utility wrappers, or if Next.js Middleware (`middleware.ts`) can be used effectively for these specific API concerns).
- [ ] **Task 2:** Implement Standardized Error Handling Middleware/Wrapper
    - [ ] Create a utility function/wrapper that takes an API Route Handler as input.
    - [ ] Inside the wrapper, use a `try-catch` block to execute the handler.
    - [ ] In the `catch` block, log the detailed error (server-side).
    - [ ] Return a generic JSON error response with an appropriate HTTP status code (e.g., 500).
- [ ] **Task 3:** Implement Request Logging Middleware/Wrapper
    - [ ] Create a utility function/wrapper that takes an API Route Handler.
    - [ ] Before executing the handler, log request details (method, path, timestamp).
    - [ ] After the handler executes (or in a `finally` block if using `try-catch` for timing), log the response status code and request duration.
- [ ] **Task 4:** Implement/Stub Authentication Check Middleware/Wrapper (Optional)
    - [ ] Create a HOF or wrapper that would take an API Route Handler.
    - [ ] Inside, include a placeholder comment (e.g., `// TODO: Implement session/token validation logic here`).
    - [ ] For now, it can simply call the wrapped handler. If it "validates," it proceeds; otherwise, it would (in the future) return a 401/403.
- [ ] **Task 5:** Apply Middleware/Wrappers to a Sample API Route
    - [ ] Create a simple test API route (e.g., `/api/test-middleware`).
    - [ ] Apply the error handling and request logging wrappers (and optional auth wrapper) to this route.
    - [ ] Test that logging occurs correctly for requests.
    - [ ] Test that if the sample route throws an error, the error handling wrapper catches it, logs it, and returns a generic error response.
- [ ] **Task 6:** Document Middleware Usage
    - [ ] Briefly document how to apply these wrappers/middleware to new API routes in the designated documentation location.

## Dev Technical Guidance

- **Location:** Middleware/wrapper functions can be placed in a shared location like `lib/api/middleware/` or `lib/utils/api-helpers.ts`.
- **Next.js App Router:** Ensure the implementation pattern is compatible with Next.js App Router API Route Handlers. Standard Express-style middleware might not apply directly; focus on composable utility functions or HOFs that wrap the Route Handlers.
- **Logging:** For PoC, `console.log` for request details and `console.error` for errors are acceptable. Ensure logs include enough information to be useful (timestamp, method, path, status, duration for requests; full error stack for errors). Follow `Architecture.md#error-handling-strategy`.
- **Error Responses:** Generic error messages to the client are crucial, as detailed in `Architecture.md#security-best-practices` (Error Handling & Information Disclosure).
- **Auth Stub:** The purpose of the auth stub is to establish a pattern for easily adding real authentication checks later without refactoring every route handler.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                               | Date       | Version | Description              | Author     |
| :----------------------------------- | :--------- | :------ | :----------------------- | :--------- |
| Initial Preparation for Dev Agent    | 2025-06-01 | 1.0     | Tasks and guidance added | Bob (SM)   |