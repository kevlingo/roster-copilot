# Story 1.11: Basic Add/Drop Player Functionality (Simplified Waivers)

## Status: Approved

## Epic: 1 - Core Platform Foundation & League Engagement MVP

## Story

- As a logged-in user, I want to be able to add available players to my team and drop players from my team so that I can manage my roster throughout the season.

## Acceptance Criteria (ACs)

1.  A logged-in user can navigate to a "Players" or "Waiver Wire" page (e.g., `app/(main)/league/[leagueId]/waivers/page.tsx`).
2.  This page lists available `NFLPlayer` records (those not on any `FantasyTeam_PoC.playerIds_onRoster` in the user's current league).
3.  The available players list displays: `fullName`, `position`, `nflTeamAbbreviation`, `status`, and `projectedPoints` (from static `NFLPlayer` data).
4.  Users can filter the available player list by position (QB, RB, WR, TE, K, DEF).
5.  Users can select an available player and initiate an "Add Player" action.
6.  If the user's `FantasyTeam_PoC.playerIds_onRoster` is full (at max size per `League_PoC.rosterSettings`), the system requires them to select a player from their current roster to "Drop" to complete the add.
7.  If the user's roster has space, they can add an available player without dropping anyone (up to roster limits).
8.  Users can select a player from their current roster (e.g., on the "My Team Roster" page - Story 1.9, or directly on the "Waivers" page if their roster is shown there) and initiate a "Drop Player" action.
9.  Upon successful add/drop:
    * `FantasyTeam_PoC.playerIds_onRoster` is updated.
    * The added player is no longer listed as available in the league.
    * The dropped player becomes available in the league.
10. The system provides clear confirmation messages for successful add, drop, or add/drop transactions.
11. The system prevents invalid transactions (e.g., adding to a full roster without a drop, dropping a non-rostered player, adding an already owned player).
12. For PoC, transactions are immediate (Free Agent style); no waiver period/bidding.

## Tasks / Subtasks

- [ ] **Task 1: Backend - API Endpoints for Add/Drop**
    - [ ] **Subtask 1.1:** Create API endpoint to list available players for a league (`GET /api/leagues/[leagueId]/available-players`).
        - [ ] Logic to determine `NFLPlayer` records not on any `FantasyTeam_PoC.playerIds_onRoster` in the league.
    - [ ] **Subtask 1.2:** Create API endpoint to add a player to user's team (`POST /api/leagues/[leagueId]/my-team/roster/add`).
        - [ ] Input: `playerIdToAdd`, optional `playerIdToDrop`.
        - [ ] Validate: Player `playerIdToAdd` is available; user's roster limits (if `playerIdToDrop` is not provided, check for space; if provided, validate `playerIdToDrop` is on user's roster).
        - [ ] Update `FantasyTeam_PoC.playerIds_onRoster` (add new, remove dropped if applicable).
    - [ ] **Subtask 1.3:** Create API endpoint to drop a player from user's team (`POST /api/leagues/[leagueId]/my-team/roster/drop` or use DELETE method).
        - [ ] Input: `playerIdToDrop`.
        - [ ] Validate: Player is on the user's roster.
        - [ ] Update `FantasyTeam_PoC.playerIds_onRoster` (remove player).
    - [ ] Apply core API middleware to all endpoints.
- [ ] **Task 2: Frontend - "Available Players / Waiver Wire" Page UI & Logic (`app/(main)/league/[leagueId]/waivers/page.tsx`)**
    - [ ] **Subtask 2.1:** Use the v0.io prompt (section related to `/league/:leagueId/waivers` page: "Key Elements: Filterable list of available (unowned) players, user's current roster display, actions to add/drop players.") to generate the initial UI structure.
    - [ ] **Subtask 2.2:** Review and adapt generated code. Ensure adherence to `Frontend-Architecture.md`.
    - [ ] **Subtask 2.3:** Implement UI to display a filterable list of available players (using `DraftPlayerCard.tsx` or a similar component structure from Story 1.8/v0.io prompt).
    - [ ] **Subtask 2.4:** Implement "Add Player" action. If roster is full, prompt user to select a player from their current roster to drop (this could be a modal showing their current roster for selection).
    - [ ] **Subtask 2.5:** (Optional UI on this page) Display a compact view of the user's current roster to aid decisions.
    - [ ] **Subtask 2.6:** Handle API calls to fetch available players and perform add operations.
    - [ ] **Subtask 2.7:** Display success/error messages and confirmations.
- [ ] **Task 3: Frontend - "Drop Player" Functionality on Roster Page**
    - [ ] Enhance the "My Team Roster" page UI (from Story 1.9 - `app/(main)/league/[leagueId]/roster/page.tsx`) to include a "Drop Player" button/action for each player.
    - [ ] On action, confirm with user, then call the "Drop Player" API endpoint.
    - [ ] Update roster display on success or show error.
- [ ] **Task 4: Testing**
    - [ ] Unit tests for backend logic (player availability, roster limit checks, add/drop operations).
    - [ ] Unit tests for frontend components (player list, add/drop modals/forms).
    - [ ] Integration tests for all related API endpoints (`available-players`, `add`, `drop`).
    - [ ] E2E tests for:
        - Viewing available players and filtering.
        - Adding a player to a roster with space.
        - Adding a player to a full roster (requiring a drop).
        - Dropping a player from the roster page.
        - Attempting invalid operations (e.g., adding an owned player).

## Dev Technical Guidance

- **Backend:**
    - Refer to `Architecture.md` for `League_PoC` (rosterSettings), `FantasyTeam_PoC`, and `NFLPlayer` data models.
    - The "available players" logic will need to efficiently query/filter against all players owned in the league.
    - Ensure add/drop operations correctly update the `FantasyTeam_PoC.playerIds_onRoster` array. Atomicity for add+drop in one transaction is important.
- **Frontend:**
    - Leverage the v0.io prompt for the initial UI of the waivers page.
    - The UI for selecting a player to drop when adding to a full roster needs to be very clear.
    - State management will be key to keeping the available player list and user's roster display in sync after transactions.
- **General:**
    - All API endpoints must be authenticated and use core middleware.

## Story Progress Notes

### Agent Model Used: `<To be filled by Dev Agent>`

### Completion Notes List

{To be filled by Dev Agent}

### Change Log

| Change                                    | Date       | Version | Description                                     | Author     |
| :---------------------------------------- | :--------- | :------ | :---------------------------------------------- | :--------- |
| Formalized by PO                          | 2025-05-31 | 0.1     | Initial formalization                           | Sarah (PO) |
| Prepared for Dev by SM                    | 2025-06-01 | 1.0     | Added detailed tasks, v0.io step, tech guidance | Bob (SM)   |